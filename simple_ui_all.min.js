var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,o,i;e=e||{},t=void 0!==e.parent?e.parent:document.body,o=void 0!==e.id?e.id:"oldie",i=Detector.getWebGLErrorMessage(),i.id=o,t.appendChild(i)}};if("object"==typeof module&&(module.exports=Detector),THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){function t(){ge.setRGB(0,0,0),we.setRGB(0,0,0),be.setRGB(0,0,0);for(var e=0,t=R.length;t>e;e++){var o=R[e],i=o.color;o instanceof THREE.AmbientLight?ge.add(i):o instanceof THREE.DirectionalLight?we.add(i):o instanceof THREE.PointLight&&be.add(i)}}function o(e,t,o){for(var i=0,r=R.length;r>i;i++){var n=R[i];if(ue.copy(n.color),n instanceof THREE.DirectionalLight){var s=ye.setFromMatrixPosition(n.matrixWorld).normalize(),a=t.dot(s);if(0>=a)continue;a*=n.intensity,o.add(ue.multiplyScalar(a))}else if(n instanceof THREE.PointLight){var s=ye.setFromMatrixPosition(n.matrixWorld),a=t.dot(ye.subVectors(s,e).normalize());if(0>=a)continue;if(a*=0==n.distance?1:1-Math.min(e.distanceTo(s)/n.distance,1),0==a)continue;a*=n.intensity,o.add(ue.multiplyScalar(a))}}}function i(e,t,o){p(o.opacity),u(o.blending);var i=t.scale.x*W,r=t.scale.y*Y,n=.5*Math.sqrt(i*i+r*r);if(fe.min.set(e.x-n,e.y-n),fe.max.set(e.x+n,e.y+n),o instanceof THREE.SpriteMaterial){var s=o.map;if(null!==s){var a=me[s.id];if((void 0===a||a.version!==s.version)&&(a=h(s),me[s.id]=a),void 0!==a.canvas){g(a.canvas);var c=s.image,l=c.width*s.offset.x,d=c.height*s.offset.y,m=c.width*s.repeat.x,v=c.height*s.repeat.y,E=i/m,w=r/v;J.save(),J.translate(e.x,e.y),0!==o.rotation&&J.rotate(o.rotation),J.translate(-i/2,-r/2),J.scale(E,w),J.translate(-l,-d),J.fillRect(l,d,m,v),J.restore()}}else g(o.color.getStyle()),J.save(),J.translate(e.x,e.y),0!==o.rotation&&J.rotate(o.rotation),J.scale(i,-r),J.fillRect(-.5,-.5,1,1),J.restore()}else o instanceof THREE.SpriteCanvasMaterial&&(f(o.color.getStyle()),g(o.color.getStyle()),J.save(),J.translate(e.x,e.y),0!==o.rotation&&J.rotate(o.rotation),J.scale(i,r),o.program(J),J.restore())}function r(e,t,o,i){if(p(i.opacity),u(i.blending),J.beginPath(),J.moveTo(e.positionScreen.x,e.positionScreen.y),J.lineTo(t.positionScreen.x,t.positionScreen.y),i instanceof THREE.LineBasicMaterial){if(m(i.linewidth),v(i.linecap),E(i.linejoin),i.vertexColors!==THREE.VertexColors)f(i.color.getStyle());else{var r=o.vertexColors[0].getStyle(),n=o.vertexColors[1].getStyle();if(r===n)f(r);else{try{var s=J.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);s.addColorStop(0,r),s.addColorStop(1,n)}catch(a){s=r}f(s)}}J.stroke(),fe.expandByScalar(2*i.linewidth)}else i instanceof THREE.LineDashedMaterial&&(m(i.linewidth),v(i.linecap),E(i.linejoin),f(i.color.getStyle()),w([i.dashSize,i.gapSize]),J.stroke(),fe.expandByScalar(2*i.linewidth),w([]))}function n(e,t,i,r,n,h,d,m){if(I.info.render.vertices+=3,I.info.render.faces++,p(m.opacity),u(m.blending),A=e.positionScreen.x,_=e.positionScreen.y,M=t.positionScreen.x,O=t.positionScreen.y,k=i.positionScreen.x,z=i.positionScreen.y,s(A,_,M,O,k,z),(m instanceof THREE.MeshLambertMaterial||m instanceof THREE.MeshPhongMaterial)&&null===m.map)de.copy(m.color),pe.copy(m.emissive),m.vertexColors===THREE.FaceColors&&de.multiply(d.color),le.copy(ge),Te.copy(e.positionWorld).add(t.positionWorld).add(i.positionWorld).divideScalar(3),o(Te,d.normalModel,le),le.multiply(de).add(pe),m.wireframe===!0?a(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):c(le);else if(m instanceof THREE.MeshBasicMaterial||m instanceof THREE.MeshLambertMaterial||m instanceof THREE.MeshPhongMaterial)if(null!==m.map){var v=m.map.mapping;v===THREE.UVMapping&&(L=d.uvs,l(A,_,M,O,k,z,L[r].x,L[r].y,L[n].x,L[n].y,L[h].x,L[h].y,m.map))}else null!==m.envMap?m.envMap.mapping===THREE.SphericalReflectionMapping&&(Re.copy(d.vertexNormalsModel[r]).applyMatrix3(He),V=.5*Re.x+.5,j=.5*Re.y+.5,Re.copy(d.vertexNormalsModel[n]).applyMatrix3(He),P=.5*Re.x+.5,F=.5*Re.y+.5,Re.copy(d.vertexNormalsModel[h]).applyMatrix3(He),D=.5*Re.x+.5,N=.5*Re.y+.5,l(A,_,M,O,k,z,V,j,P,F,D,N,m.envMap)):(le.copy(m.color),m.vertexColors===THREE.FaceColors&&le.multiply(d.color),m.wireframe===!0?a(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):c(le));else m instanceof THREE.MeshDepthMaterial?(le.r=le.g=le.b=1-b(e.positionScreen.z*e.positionScreen.w,H.near,H.far),m.wireframe===!0?a(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):c(le)):m instanceof THREE.MeshNormalMaterial?(Re.copy(d.normalModel).applyMatrix3(He),le.setRGB(Re.x,Re.y,Re.z).multiplyScalar(.5).addScalar(.5),m.wireframe===!0?a(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):c(le)):(le.setRGB(1,1,1),m.wireframe===!0?a(le,m.wireframeLinewidth,m.wireframeLinecap,m.wireframeLinejoin):c(le))}function s(e,t,o,i,r,n){J.beginPath(),J.moveTo(e,t),J.lineTo(o,i),J.lineTo(r,n),J.closePath()}function a(e,t,o,i){m(t),v(o),E(i),f(e.getStyle()),J.stroke(),fe.expandByScalar(2*t)}function c(e){g(e.getStyle()),J.fill()}function h(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image,o=document.createElement("canvas");o.width=t.width,o.height=t.height;var i=o.getContext("2d");i.setTransform(1,0,0,-1,0,t.height),i.drawImage(t,0,0);var r=e.wrapS===THREE.RepeatWrapping,n=e.wrapT===THREE.RepeatWrapping,s="no-repeat";return r===!0&&n===!0?s="repeat":r===!0?s="repeat-x":n===!0&&(s="repeat-y"),{canvas:J.createPattern(o,s),version:e.version}}function l(e,t,o,i,r,n,s,a,c,l,d,p,u){var m=me[u.id];if((void 0===m||m.version!==u.version)&&(m=h(u),me[u.id]=m),void 0===m.canvas)return g("rgba( 0, 0, 0, 1)"),void J.fill();g(m.canvas);var v,E,f,w,b,y,T,R,H=u.offset.x/u.repeat.x,C=u.offset.y/u.repeat.y,x=u.image.width*u.repeat.x,S=u.image.height*u.repeat.y;s=(s+H)*x,a=(a+C)*S,c=(c+H)*x,l=(l+C)*S,d=(d+H)*x,p=(p+C)*S,o-=e,i-=t,r-=e,n-=t,c-=s,l-=a,d-=s,p-=a,T=c*p-d*l,0!==T&&(R=1/T,v=(p*o-l*r)*R,E=(p*i-l*n)*R,f=(c*r-d*o)*R,w=(c*n-d*i)*R,b=e-v*s-f*a,y=t-E*s-w*a,J.save(),J.transform(v,E,f,w,b,y),J.fill(),J.restore())}function d(e,t,o){var i,r=t.x-e.x,n=t.y-e.y,s=r*r+n*n;0!==s&&(i=o/Math.sqrt(s),r*=i,n*=i,t.x+=r,t.y+=n,e.x-=r,e.y-=n)}function p(e){oe!==e&&(J.globalAlpha=e,oe=e)}function u(e){ie!==e&&(e===THREE.NormalBlending?J.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?J.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending&&(J.globalCompositeOperation="darker"),ie=e)}function m(e){se!==e&&(J.lineWidth=e,se=e)}function v(e){ae!==e&&(J.lineCap=e,ae=e)}function E(e){ce!==e&&(J.lineJoin=e,ce=e)}function f(e){re!==e&&(J.strokeStyle=e,re=e)}function g(e){ne!==e&&(J.fillStyle=e,ne=e)}function w(e){he.length!==e.length&&(J.setLineDash(e),he=e)}console.log("THREE.CanvasRenderer",THREE.REVISION);var b=THREE.Math.smoothstep;e=e||{};var y,T,R,H,C,x,S,A,_,M,O,k,z,L,V,j,P,F,D,N,I=this,B=new THREE.Projector,G=void 0!==e.canvas?e.canvas:document.createElement("canvas"),q=G.width,$=G.height,W=Math.floor(q/2),Y=Math.floor($/2),U=0,X=0,Q=q,Z=$,K=1,J=G.getContext("2d",{alpha:e.alpha===!0}),ee=new THREE.Color(0),te=e.alpha===!0?0:1,oe=1,ie=0,re=null,ne=null,se=null,ae=null,ce=null,he=[],le=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),de=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),pe=new THREE.Color,ue=new THREE.Color,me={},ve=new THREE.Box2,Ee=new THREE.Box2,fe=new THREE.Box2,ge=new THREE.Color,we=new THREE.Color,be=new THREE.Color,ye=new THREE.Vector3,Te=new THREE.Vector3,Re=new THREE.Vector3,He=new THREE.Matrix3;void 0===J.setLineDash&&(J.setLineDash=function(){}),this.domElement=G,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return J},this.getContextAttributes=function(){return J.getContextAttributes()},this.getPixelRatio=function(){return K},this.setPixelRatio=function(e){void 0!==e&&(K=e)},this.setSize=function(e,t,o){q=e*K,$=t*K,G.width=q,G.height=$,W=Math.floor(q/2),Y=Math.floor($/2),o!==!1&&(G.style.width=e+"px",G.style.height=t+"px"),ve.min.set(-W,-Y),ve.max.set(W,Y),Ee.min.set(-W,-Y),Ee.max.set(W,Y),oe=1,ie=0,re=null,ne=null,se=null,ae=null,ce=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,o,i){U=e*K,X=t*K,Q=o*K,Z=i*K},this.setScissor=function(){},this.enableScissorTest=function(){},this.setClearColor=function(e,t){ee.set(e),te=void 0!==t?t:1,Ee.min.set(-W,-Y),Ee.max.set(W,Y)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return ee},this.getClearAlpha=function(){return te},this.getMaxAnisotropy=function(){return 0},this.clear=function(){Ee.empty()===!1&&(Ee.intersect(ve),Ee.expandByScalar(2),Ee.min.x=Ee.min.x+W,Ee.min.y=-Ee.min.y+Y,Ee.max.x=Ee.max.x+W,Ee.max.y=-Ee.max.y+Y,1>te&&J.clearRect(0|Ee.min.x,0|Ee.max.y,Ee.max.x-Ee.min.x|0,Ee.min.y-Ee.max.y|0),te>0&&(u(THREE.NormalBlending),p(1),g("rgba("+Math.floor(255*ee.r)+","+Math.floor(255*ee.g)+","+Math.floor(255*ee.b)+","+te+")"),J.fillRect(0|Ee.min.x,0|Ee.max.y,Ee.max.x-Ee.min.x|0,Ee.min.y-Ee.max.y|0)),Ee.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,o){if(o instanceof THREE.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),I.info.render.vertices=0,I.info.render.faces=0,J.setTransform(Q/q,0,0,-Z/$,U,$-X),J.translate(W,Y),y=B.projectScene(e,o,this.sortObjects,this.sortElements),T=y.elements,R=y.lights,H=o,He.getNormalMatrix(o.matrixWorldInverse),t();for(var s=0,a=T.length;a>s;s++){var c=T[s],h=c.material;if(void 0!==h&&0!==h.opacity){if(fe.makeEmpty(),c instanceof THREE.RenderableSprite)C=c,C.x*=W,C.y*=Y,i(C,c,h);else if(c instanceof THREE.RenderableLine)C=c.v1,x=c.v2,C.positionScreen.x*=W,C.positionScreen.y*=Y,x.positionScreen.x*=W,x.positionScreen.y*=Y,fe.setFromPoints([C.positionScreen,x.positionScreen]),ve.isIntersectionBox(fe)===!0&&r(C,x,c,h);else if(c instanceof THREE.RenderableFace){if(C=c.v1,x=c.v2,S=c.v3,C.positionScreen.z<-1||C.positionScreen.z>1)continue;if(x.positionScreen.z<-1||x.positionScreen.z>1)continue;if(S.positionScreen.z<-1||S.positionScreen.z>1)continue;C.positionScreen.x*=W,C.positionScreen.y*=Y,x.positionScreen.x*=W,x.positionScreen.y*=Y,S.positionScreen.x*=W,S.positionScreen.y*=Y,h.overdraw>0&&(d(C.positionScreen,x.positionScreen,h.overdraw),d(x.positionScreen,S.positionScreen,h.overdraw),d(S.positionScreen,C.positionScreen,h.overdraw)),fe.setFromPoints([C.positionScreen,x.positionScreen,S.positionScreen]),ve.isIntersectionBox(fe)===!0&&n(C,x,S,0,1,2,c,h)}Ee.union(fe)}}J.setTransform(1,0,0,1,0,0)}},THREE.TrackballControls=function(e,t,o){function i(e){p.enabled!==!1&&(window.removeEventListener("keydown",i),v=p._state,p._state===p.STATE.NONE&&(e.keyCode!==p.keys[p.STATE.ROTATE]||p.noRotate?e.keyCode!==p.keys[p.STATE.ZOOM]&&!e.shiftKey||p.noZoom?e.keyCode!==p.keys[p.STATE.PAN]&&!e.ctrlKey||p.noPan||(p._state=p.STATE.PAN):p._state=p.STATE.ZOOM:p._state=p.STATE.ROTATE))}function r(e){p.enabled!==!1&&(p._state=v,window.addEventListener("keydown",i,!1))}function n(e){p.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),p._state===p.STATE.NONE&&(p._state=e.button),p._state!==p.STATE.ROTATE||p.noRotate?p._state!==p.STATE.ZOOM||p.noZoom?p._state!==p.STATE.PAN||p.noPan||(p._panStart.copy(T(e.pageX,e.pageY)),p._panEnd.copy(p._panStart)):(p._zoomStart.copy(T(e.pageX,e.pageY)),p._zoomEnd.copy(p._zoomStart)):(p._rotateStart.copy(R(e.pageX,e.pageY)),p._rotateEnd.copy(p._rotateStart)),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",a,!1),p.dispatchEvent(b))}function s(e){p.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),p._state!==p.STATE.ROTATE||p.noRotate?p._state!==p.STATE.ZOOM||p.noZoom?p._state!==p.STATE.PAN||p.noPan||p._panEnd.copy(T(e.pageX,e.pageY)):p._zoomEnd.copy(T(e.pageX,e.pageY)):p._rotateEnd.copy(R(e.pageX,e.pageY)))}function a(e){p.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),p._state=p.STATE.NONE,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),p.dispatchEvent(y))}function c(e){if(p.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),p._zoomStart.y=.01*t,p.dispatchEvent(b),p.dispatchEvent(y)}}function h(e){if(p.enabled!==!1){switch(e.touches.length){case 1:p._state=p.STATE.TOUCH_ROTATE,p._rotateStart.copy(R(e.touches[0].pageX,e.touches[0].pageY)),p._rotateEnd.copy(p._rotateStart);break;case 2:p._state=p.STATE.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY;g=f=Math.sqrt(t*t+o*o);var i=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;p._panStart.copy(T(i,r)),p._panEnd.copy(p._panStart);break;default:p._state=p.STATE.NONE}p.dispatchEvent(b)}}function l(e){if(p.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:p._rotateEnd.copy(R(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY;g=Math.sqrt(t*t+o*o);var i=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;p._panEnd.copy(T(i,r));break;default:p._state=p.STATE.NONE}}function d(e){if(p.enabled!==!1){switch(e.touches.length){case 1:p._rotateEnd.copy(R(e.touches[0].pageX,e.touches[0].pageY)),p._rotateStart.copy(p._rotateEnd);break;case 2:f=g=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;p._panEnd.copy(T(t,o)),p._panStart.copy(p._panEnd)}p._state=p.STATE.NONE,p.dispatchEvent(y)}}var p=this;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var u=1e-6,m=new THREE.Vector3;this._state=this.STATE.NONE;var v=this.STATE.NONE,E=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var f=0,g=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var w={type:"change"},b={type:"start"},y={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var T=function(){var e=new THREE.Vector2;return function(t,o){return e.set((t-p.screen.left)/p.screen.width,(o-p.screen.top)/p.screen.height),e}}(),R=function(){var e=new THREE.Vector3,t=new THREE.Vector3,o=new THREE.Vector3;return function(i,r){o.set((i-.5*p.screen.width-p.screen.left)/(.5*p.screen.width),(.5*p.screen.height+p.screen.top-r)/(.5*p.screen.height),0);var n=o.length();return p.noRoll?n<Math.SQRT1_2?o.z=Math.sqrt(1-n*n):o.z=.5/n:n>1?o.normalize():o.z=Math.sqrt(1-n*n),E.copy(p.object.position).sub(p.target),e.copy(p.object.up).setLength(o.y),e.add(t.copy(p.object.up).cross(E).setLength(o.x)),e.add(E.setLength(o.z)),e}}();this.rotateCamera=function(e,t){var i=new THREE.Vector3,r=new THREE.Quaternion;return function(e,t){var n;void 0===e&&(n=Math.acos(p._rotateStart.dot(p._rotateEnd)/p._rotateStart.length()/p._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(i.crossVectors(p._rotateStart,p._rotateEnd).normalize(),n*=p.rotateSpeed,r.setFromAxisAngle(i,-n)):r.copy(e),(void 0===t||t===!0)&&o.quaternion.multiplyQuaternions(r,o.quaternion),E.applyQuaternion(r),p.object.up.applyQuaternion(r),p._rotateEnd.applyQuaternion(r),p.staticMoving?p._rotateStart.copy(p._rotateEnd):(r.setFromAxisAngle(i,n*(p.dynamicDampingFactor-1)),p._rotateStart.applyQuaternion(r)))}}(),this.zoomCamera=function(e,t){if(p._state===p.STATE.TOUCH_ZOOM_PAN){var i;void 0!==e?i=e:(i=f/g,f=g),E.multiplyScalar(i),(void 0===t||t===!0)&&(o._zoomFactor*=i)}else{var i;i=void 0!==e?e:1+(p._zoomEnd.y-p._zoomStart.y)*p.zoomSpeed,(void 0===t||t===!0)&&(o._zoomFactor*=i),1!==i&&(E.multiplyScalar(i),p.staticMoving?p._zoomStart.copy(p._zoomEnd):p._zoomStart.y+=(p._zoomEnd.y-p._zoomStart.y)*this.dynamicDampingFactor)}},this.panCamera=function(e,t){var i=new THREE.Vector2,r=new THREE.Vector3,n=new THREE.Vector3;return function(e,t){void 0!==e?(i=e,(void 0===t||t===!0)&&o.mouseChange.add(e)):(i.copy(p._panEnd).sub(p._panStart),(void 0===t||t===!0)&&o.mouseChange.add(p._panEnd).sub(p._panStart)),i.lengthSq()&&(i.multiplyScalar(E.length()*p.panSpeed),n.copy(E).cross(p.object.up).setLength(i.x),n.add(r.copy(p.object.up).setLength(i.y)),p.object.position.add(n),p.target.add(n),p.staticMoving?p._panStart.copy(p._panEnd):p._panStart.add(i.subVectors(p._panEnd,p._panStart).multiplyScalar(p.dynamicDampingFactor)))}}(),this.checkDistances=function(){p.noZoom&&p.noPan||(E.lengthSq()>p.maxDistance*p.maxDistance&&p.object.position.addVectors(p.target,E.setLength(p.maxDistance)),E.lengthSq()<p.minDistance*p.minDistance&&p.object.position.addVectors(p.target,E.setLength(p.minDistance)))},this.update=function(e){E.subVectors(p.object.position,p.target),p.noRotate||(void 0!==e&&void 0!==e.quaternion?p.rotateCamera(e.quaternion,e.update):p.rotateCamera()),p.noZoom||(void 0!==e&&void 0!==e._zoomFactor?p.zoomCamera(e._zoomFactor,e.update):p.zoomCamera()),p.noPan||(void 0!==e&&void 0!==e.mouseChange?p.panCamera(e.mouseChange,e.update):p.panCamera()),p.object.position.addVectors(p.target,E),p.checkDistances(),p.object.lookAt(p.target),m.distanceToSquared(p.object.position)>u&&(p.dispatchEvent(w),m.copy(p.object.position))},this.reset=function(){p._state=p.STATE.NONE,v=p.STATE.NONE,p.target.copy(p.target0),p.object.position.copy(p.position0),p.object.up.copy(p.up0),E.subVectors(p.object.position,p.target),p.object.lookAt(p.target),p.dispatchEvent(w),m.copy(p.object.position)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",h,!1),this.domElement.addEventListener("touchend",d,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",i,!1),window.addEventListener("keyup",r,!1),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls,THREE.OrthographicTrackballControls=function(e,t,o){function i(e){p.enabled!==!1&&(window.removeEventListener("keydown",i),f=p._state,p._state===u.NONE&&(e.keyCode!==p.keys[u.ROTATE]||p.noRotate?e.keyCode!==p.keys[u.ZOOM]&&!e.shiftKey||p.noZoom?e.keyCode!==p.keys[u.PAN]&&!e.ctrlKey||p.noPan||(p._state=u.PAN):p._state=u.ZOOM:p._state=u.ROTATE))}function r(e){p.enabled!==!1&&(p._state=f,window.addEventListener("keydown",i,!1))}function n(e){p.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),p._state===u.NONE&&(p._state=e.button),p._state!==u.ROTATE||p.noRotate?p._state!==u.ZOOM||p.noZoom?p._state!==u.PAN||p.noPan||(p._panStart.copy(C(e.pageX,e.pageY)),p._panEnd.copy(p._panStart)):(p._zoomStart.copy(C(e.pageX,e.pageY)),p._zoomEnd.copy(p._zoomStart)):(p._rotateStart.copy(x(e.pageX,e.pageY)),p._rotateEnd.copy(p._rotateStart)),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",a,!1),p.dispatchEvent(R))}function s(e){p.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),p._state!==u.ROTATE||p.noRotate?p._state!==u.ZOOM||p.noZoom?p._state!==u.PAN||p.noPan||p._panEnd.copy(C(e.pageX,e.pageY)):p._zoomEnd.copy(C(e.pageX,e.pageY)):p._rotateEnd.copy(x(e.pageX,e.pageY)))}function a(e){p.enabled!==!1&&(e.preventDefault(),e.stopPropagation(),p._state=u.NONE,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),p.dispatchEvent(H))}function c(e){if(p.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),p._zoomStart.y=.01*t,p.dispatchEvent(R),p.dispatchEvent(H)}}function h(e){if(p.enabled!==!1){switch(e.touches.length){case 1:p._state=u.TOUCH_ROTATE,p._rotateStart.copy(x(e.touches[0].pageX,e.touches[0].pageY)),p._rotateEnd.copy(p._rotateStart);break;case 2:p._state=u.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY;y=b=Math.sqrt(t*t+o*o);var i=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;p._panStart.copy(C(i,r)),p._panEnd.copy(p._panStart);break;default:p._state=u.NONE}p.dispatchEvent(R)}}function l(e){if(p.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:p._rotateEnd.copy(x(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY;y=Math.sqrt(t*t+o*o);var i=(e.touches[0].pageX+e.touches[1].pageX)/2,r=(e.touches[0].pageY+e.touches[1].pageY)/2;p._panEnd.copy(C(i,r));break;default:p._state=u.NONE}}function d(e){if(p.enabled!==!1){switch(e.touches.length){case 1:p._rotateEnd.copy(x(e.touches[0].pageX,e.touches[0].pageY)),p._rotateStart.copy(p._rotateEnd);break;case 2:b=y=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;p._panEnd.copy(C(t,o)),p._panStart.copy(p._panEnd)}p._state=u.NONE,p.dispatchEvent(H)}}var p=this,u={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=.5,this.zoomSpeed=1.2;var m=.01;this.zoomSpeed*=m,this.panSpeed=.03,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.keys=[65,83,68],this.target=new THREE.Vector3;var v=1e-6,E=new THREE.Vector3;this._state=u.NONE;var f=u.NONE,g=new THREE.Vector3;this._rotateStart=new THREE.Vector3,this._rotateEnd=new THREE.Vector3,this._zoomStart=new THREE.Vector2,this._zoomEnd=new THREE.Vector2;var w=1,b=0,y=0;this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0=new THREE.Vector2((this.left0+this.right0)/2,(this.top0+this.bottom0)/2);var T={type:"change"},R={type:"start"},H={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}this.left0=this.object.left,this.right0=this.object.right,this.top0=this.object.top,this.bottom0=this.object.bottom,this.center0.set((this.left0+this.right0)/2,(this.top0+this.bottom0)/2)},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var C=function(){var e=new THREE.Vector2;return function(t,o){return e.set((t-p.screen.left)/p.screen.width,(o-p.screen.top)/p.screen.height),e}}(),x=function(){var e=new THREE.Vector3,t=new THREE.Vector3,o=new THREE.Vector3;return function(i,r){o.set((i-.5*p.screen.width-p.screen.left)/(.5*p.screen.width),(.5*p.screen.height+p.screen.top-r)/(.5*p.screen.height),0);var n=o.length();return p.noRoll?n<Math.SQRT1_2?o.z=Math.sqrt(1-n*n):o.z=.5/n:n>1?o.normalize():o.z=Math.sqrt(1-n*n),g.copy(p.object.position).sub(p.target),e.copy(p.object.up).setLength(o.y),e.add(t.copy(p.object.up).cross(g).setLength(o.x)),e.add(g.setLength(o.z)),e}}();this.rotateCamera=function(e,t){var i=new THREE.Vector3,r=new THREE.Quaternion;return function(e,t){var n;void 0===e&&(n=Math.acos(p._rotateStart.dot(p._rotateEnd)/p._rotateStart.length()/p._rotateEnd.length())),(n||void 0!==e)&&(void 0===e?(i.crossVectors(p._rotateStart,p._rotateEnd).normalize(),n*=p.rotateSpeed,r.setFromAxisAngle(i,-n)):r.copy(e),(void 0===t||t===!0)&&o.quaternion.multiplyQuaternions(r,o.quaternion),g.applyQuaternion(r),p.object.up.applyQuaternion(r),p._rotateEnd.applyQuaternion(r),p.staticMoving?p._rotateStart.copy(p._rotateEnd):(r.setFromAxisAngle(i,n*(p.dynamicDampingFactor-1)),p._rotateStart.applyQuaternion(r)))}}(),this.zoomCamera=function(e,t){var i;p._state===u.TOUCH_ZOOM_PAN?void 0!==e?i=e:(i=b/y,b=y):i=void 0!==e?e:1+(p._zoomEnd.y-p._zoomStart.y)*p.zoomSpeed/m,(void 0===t||t===!0)&&(o._zoomFactor*=i),1!==i&&(w=i,p.object.left=w*p.left0+(1-w)*p.center0.x,p.object.right=w*p.right0+(1-w)*p.center0.x,p.object.top=w*p.top0+(1-w)*p.center0.y,p.object.bottom=w*p.bottom0+(1-w)*p.center0.y,p.staticMoving?p._zoomStart.copy(p._zoomEnd):p._zoomStart.y+=(p._zoomEnd.y-p._zoomStart.y)*this.dynamicDampingFactor)},this.panCamera=function(e,t){var i=new THREE.Vector2,r=new THREE.Vector3,n=new THREE.Vector3;return function(e,t){void 0!==e?(i=e,(void 0===t||t===!0)&&o.mouseChange.add(e)):(i.copy(p._panEnd).sub(p._panStart),(void 0===t||t===!0)&&o.mouseChange.add(p._panEnd).sub(p._panStart)),i.lengthSq()&&(i.multiplyScalar(g.length()*p.panSpeed),n.copy(g).cross(p.object.up).setLength(i.x),n.add(r.copy(p.object.up).setLength(i.y)),p.object.position.add(n),p.target.add(n),p.staticMoving?p._panStart.copy(p._panEnd):p._panStart.add(i.subVectors(p._panEnd,p._panStart).multiplyScalar(p.dynamicDampingFactor)))}}(),this.update=function(e){g.subVectors(p.object.position,p.target),p.noRotate||(void 0!==e&&void 0!==e.quaternion?p.rotateCamera(e.quaternion,e.update):p.rotateCamera()),p.noZoom||(void 0!==e&&void 0!==e._zoomFactor?p.zoomCamera(e._zoomFactor,e.update):p.zoomCamera(),p.object.updateProjectionMatrix()),p.noPan||(void 0!==e&&void 0!==e.mouseChange?p.panCamera(e.mouseChange,e.update):p.panCamera()),p.object.position.addVectors(p.target,g),p.object.lookAt(p.target),E.distanceToSquared(p.object.position)>v&&(p.dispatchEvent(T),E.copy(p.object.position))},this.reset=function(){p._state=u.NONE,f=u.NONE,p.target.copy(p.target0),p.object.position.copy(p.position0),p.object.up.copy(p.up0),g.subVectors(p.object.position,p.target),p.object.left=p.left0,p.object.right=p.right0,p.object.top=p.top0,p.object.bottom=p.bottom0,p.object.lookAt(p.target),p.dispatchEvent(T),E.copy(p.object.position)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",c,!1),this.domElement.addEventListener("DOMMouseScroll",c,!1),this.domElement.addEventListener("touchstart",h,!1),this.domElement.addEventListener("touchend",d,!1),this.domElement.addEventListener("touchmove",l,!1),window.addEventListener("keydown",i,!1),window.addEventListener("keyup",r,!1),this.handleResize(),this.update()},THREE.OrthographicTrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrthographicTrackballControls.prototype.constructor=THREE.OrthographicTrackballControls,THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null},THREE.Projector=function(){function e(){if(c===w){var e=new THREE.RenderableObject;return g.push(e),w++,c++,e}return g[c++]}function t(){if(l===y){var e=new THREE.RenderableVertex;return b.push(e),y++,l++,e}return b[l++]}function o(){if(p===R){var e=new THREE.RenderableFace;return T.push(e),R++,p++,e}return T[p++]}function i(){if(m===C){var e=new THREE.RenderableLine;return H.push(e),C++,m++,e}return H[m++]}function r(){if(E===S){var e=new THREE.RenderableSprite;return x.push(e),S++,E++,e}return x[E++]}function n(e,t){return e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function s(e,t){var o=0,i=1,r=e.z+e.w,n=t.z+t.w,s=-e.z+e.w,a=-t.z+t.w;return r>=0&&n>=0&&s>=0&&a>=0?!0:0>r&&0>n||0>s&&0>a?!1:(0>r?o=Math.max(o,r/(r-n)):0>n&&(i=Math.min(i,r/(r-n))),0>s?o=Math.max(o,s/(s-a)):0>a&&(i=Math.min(i,s/(s-a))),o>i?!1:(e.lerp(t,o),t.lerp(e,1-i),!0))}var a,c,h,l,d,p,u,m,v,E,f,g=[],w=0,b=[],y=0,T=[],R=0,H=[],C=0,x=[],S=0,A={objects:[],lights:[],elements:[]},_=new THREE.Vector3,M=new THREE.Vector3,O=new THREE.Vector3,k=new THREE.Vector3,z=new THREE.Vector4,L=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),V=new THREE.Box3,j=new Array(3),P=(new Array(4),
new THREE.Matrix4),F=new THREE.Matrix4,D=new THREE.Matrix4,N=new THREE.Matrix3,I=new THREE.Frustum,B=new THREE.Vector4,G=new THREE.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var q=function(){var e=[],r=[],n=null,s=null,a=new THREE.Matrix3,c=function(t){n=t,s=n.material,a.getNormalMatrix(n.matrixWorld),e.length=0,r.length=0},l=function(e){var t=e.position,o=e.positionWorld,i=e.positionScreen;o.copy(t).applyMatrix4(f),i.copy(o).applyMatrix4(F);var r=1/i.w;i.x*=r,i.y*=r,i.z*=r,e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1},p=function(e,o,i){h=t(),h.position.set(e,o,i),l(h)},m=function(t,o,i){e.push(t,o,i)},v=function(e,t){r.push(e,t)},E=function(e,t,o){return e.visible===!0||t.visible===!0||o.visible===!0?!0:(j[0]=e.positionScreen,j[1]=t.positionScreen,j[2]=o.positionScreen,L.isIntersectionBox(V.setFromPoints(j)))},g=function(e,t,o){return(o.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(o.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0},w=function(e,t){var o=b[e],r=b[t];u=i(),u.id=n.id,u.v1.copy(o),u.v2.copy(r),u.z=(o.positionScreen.z+r.positionScreen.z)/2,u.material=n.material,A.elements.push(u)},y=function(t,i,c){var h=b[t],l=b[i],p=b[c];if(E(h,l,p)!==!1&&(s.side===THREE.DoubleSide||g(h,l,p)===!0)){d=o(),d.id=n.id,d.v1.copy(h),d.v2.copy(l),d.v3.copy(p),d.z=(h.positionScreen.z+l.positionScreen.z+p.positionScreen.z)/3;for(var u=0;3>u;u++){var m=3*arguments[u],v=d.vertexNormalsModel[u];v.set(e[m],e[m+1],e[m+2]),v.applyMatrix3(a).normalize();var f=2*arguments[u],w=d.uvs[u];w.set(r[f],r[f+1])}d.vertexNormalsLength=3,d.material=n.material,A.elements.push(d)}};return{setObject:c,projectVertex:l,checkTriangleVisibility:E,checkBackfaceCulling:g,pushVertex:p,pushNormal:m,pushUv:v,pushLine:w,pushTriangle:y}},$=new q;this.projectScene=function(h,g,w,y){p=0,m=0,E=0,A.elements.length=0,h.autoUpdate===!0&&h.updateMatrixWorld(),void 0===g.parent&&g.updateMatrixWorld(),P.copy(g.matrixWorldInverse.getInverse(g.matrixWorld)),F.multiplyMatrices(g.projectionMatrix,P),I.setFromMatrix(F),c=0,A.objects.length=0,A.lights.length=0,h.traverseVisible(function(t){if(t instanceof THREE.Light)A.lights.push(t);else if(t instanceof THREE.Mesh||t instanceof THREE.Line||t instanceof THREE.Sprite){if(t.material.visible===!1)return;(t.frustumCulled===!1||I.intersectsObject(t)===!0)&&(a=e(),a.id=t.id,a.object=t,k.setFromMatrixPosition(t.matrixWorld),k.applyProjection(F),a.z=k.z,A.objects.push(a))}}),w===!0&&A.objects.sort(n);for(var T=0,R=A.objects.length;R>T;T++){var H=A.objects[T].object,C=H.geometry;if($.setObject(H),f=H.matrixWorld,l=0,H instanceof THREE.Mesh){if(C instanceof THREE.BufferGeometry){var x=C.attributes,S=C.offsets;if(void 0===x.position)continue;for(var L=x.position.array,V=0,j=L.length;j>V;V+=3)$.pushVertex(L[V],L[V+1],L[V+2]);if(void 0!==x.normal)for(var q=x.normal.array,V=0,j=q.length;j>V;V+=3)$.pushNormal(q[V],q[V+1],q[V+2]);if(void 0!==x.uv)for(var W=x.uv.array,V=0,j=W.length;j>V;V+=2)$.pushUv(W[V],W[V+1]);if(void 0!==x.index){var Y=x.index.array;if(S.length>0)for(var T=0;T<S.length;T++)for(var U=S[T],X=U.index,V=U.start,j=U.start+U.count;j>V;V+=3)$.pushTriangle(Y[V]+X,Y[V+1]+X,Y[V+2]+X);else for(var V=0,j=Y.length;j>V;V+=3)$.pushTriangle(Y[V],Y[V+1],Y[V+2])}else for(var V=0,j=L.length/3;j>V;V+=3)$.pushTriangle(V,V+1,V+2)}else if(C instanceof THREE.Geometry){var Q=C.vertices,Z=C.faces,K=C.faceVertexUvs[0];N.getNormalMatrix(f);for(var J=H.material instanceof THREE.MeshFaceMaterial,ee=J===!0?H.material:null,te=0,oe=Q.length;oe>te;te++){var ie=Q[te];$.pushVertex(ie.x,ie.y,ie.z)}for(var re=0,ne=Z.length;ne>re;re++){var se=Z[re],ae=J===!0?ee.materials[se.materialIndex]:H.material;if(void 0!==ae){var ce=ae.side,he=b[se.a],le=b[se.b],de=b[se.c];if(ae.morphTargets===!0){var pe=C.morphTargets,ue=H.morphTargetInfluences,me=he.position,ve=le.position,Ee=de.position;_.set(0,0,0),M.set(0,0,0),O.set(0,0,0);for(var fe=0,ge=pe.length;ge>fe;fe++){var we=ue[fe];if(0!==we){var be=pe[fe].vertices;_.x+=(be[se.a].x-me.x)*we,_.y+=(be[se.a].y-me.y)*we,_.z+=(be[se.a].z-me.z)*we,M.x+=(be[se.b].x-ve.x)*we,M.y+=(be[se.b].y-ve.y)*we,M.z+=(be[se.b].z-ve.z)*we,O.x+=(be[se.c].x-Ee.x)*we,O.y+=(be[se.c].y-Ee.y)*we,O.z+=(be[se.c].z-Ee.z)*we}}he.position.add(_),le.position.add(M),de.position.add(O),$.projectVertex(he),$.projectVertex(le),$.projectVertex(de)}if($.checkTriangleVisibility(he,le,de)!==!1){var ye=$.checkBackfaceCulling(he,le,de);if(ce!==THREE.DoubleSide){if(ce===THREE.FrontSide&&ye===!1)continue;if(ce===THREE.BackSide&&ye===!0)continue}d=o(),d.id=H.id,d.v1.copy(he),d.v2.copy(le),d.v3.copy(de),d.normalModel.copy(se.normal),ye!==!1||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||d.normalModel.negate(),d.normalModel.applyMatrix3(N).normalize();for(var Te=se.vertexNormals,Re=0,He=Math.min(Te.length,3);He>Re;Re++){var Ce=d.vertexNormalsModel[Re];Ce.copy(Te[Re]),ye!==!1||ce!==THREE.BackSide&&ce!==THREE.DoubleSide||Ce.negate(),Ce.applyMatrix3(N).normalize()}d.vertexNormalsLength=Te.length;var xe=K[re];if(void 0!==xe)for(var Se=0;3>Se;Se++)d.uvs[Se].copy(xe[Se]);d.color=se.color,d.material=ae,d.z=(he.positionScreen.z+le.positionScreen.z+de.positionScreen.z)/3,A.elements.push(d)}}}}}else if(H instanceof THREE.Line){if(C instanceof THREE.BufferGeometry){var x=C.attributes;if(void 0!==x.position){for(var L=x.position.array,V=0,j=L.length;j>V;V+=3)$.pushVertex(L[V],L[V+1],L[V+2]);if(void 0!==x.index)for(var Y=x.index.array,V=0,j=Y.length;j>V;V+=2)$.pushLine(Y[V],Y[V+1]);else for(var Ae=H.mode===THREE.LinePieces?2:1,V=0,j=L.length/3-1;j>V;V+=Ae)$.pushLine(V,V+1)}}else if(C instanceof THREE.Geometry){D.multiplyMatrices(F,f);var Q=H.geometry.vertices;if(0===Q.length)continue;he=t(),he.positionScreen.copy(Q[0]).applyMatrix4(D);for(var Ae=H.mode===THREE.LinePieces?2:1,te=1,oe=Q.length;oe>te;te++)he=t(),he.positionScreen.copy(Q[te]).applyMatrix4(D),(te+1)%Ae>0||(le=b[l-2],B.copy(he.positionScreen),G.copy(le.positionScreen),s(B,G)===!0&&(B.multiplyScalar(1/B.w),G.multiplyScalar(1/G.w),u=i(),u.id=H.id,u.v1.positionScreen.copy(B),u.v2.positionScreen.copy(G),u.z=Math.max(B.z,G.z),u.material=H.material,H.material.vertexColors===THREE.VertexColors&&(u.vertexColors[0].copy(H.geometry.colors[te]),u.vertexColors[1].copy(H.geometry.colors[te-1])),A.elements.push(u)))}}else if(H instanceof THREE.Sprite){z.set(f.elements[12],f.elements[13],f.elements[14],1),z.applyMatrix4(F);var _e=1/z.w;z.z*=_e,z.z>=-1&&z.z<=1&&(v=r(),v.id=H.id,v.x=z.x*_e,v.y=z.y*_e,v.z=z.z,v.object=H,v.rotation=H.rotation,v.scale.x=H.scale.x*Math.abs(v.x-(z.x+g.projectionMatrix.elements[0])/(z.w+g.projectionMatrix.elements[12])),v.scale.y=H.scale.y*Math.abs(v.y-(z.y+g.projectionMatrix.elements[5])/(z.w+g.projectionMatrix.elements[13])),v.material=H.material,A.elements.push(v))}}return y===!0&&A.elements.sort(n),A}},"undefined"==typeof jQuery)throw new Error("iCn3D requires jQuery");var iCn3D=function(e){this.REVISION="1",this.id=e,this.container=$("#"+e),this.overdraw=0,this.bHighlight=1,Detector.webgl?(this.renderer=new THREE.WebGLRenderer({canvas:this.container.get(0),antialias:!0,preserveDrawingBuffer:!0}),this.overdraw=0):(alert("Currently your web browser has a problem on WebGL, and CanvasRenderer instead of WebGLRenderer is used. If you are using Chrome, open a new tab for the same URL and WebGL may work again."),this.renderer=new THREE.CanvasRenderer({canvas:this.container.get(0)}),this.overdraw=.5,this.bHighlight=2),this.matShader=this.setOutlineColor("yellow"),this.fractionOfColor=new THREE.Color(.1,.1,.1),this.WIDTH=this.container.width(),this.HEIGHT=this.container.height(),this.setWidthHeight(this.WIDTH,this.HEIGHT),this.axis=!1,this.picking=1,this.pickpair=!1,this.pickedatomNum=0,this.pickedatom=void 0,this.pickedatom2=void 0,this.bStopRotate=!1,this.bCalphaOnly=!1,this.bSSOnly=!1,this.effects={none:this.renderer},this.maxD=500,this.camera_z=2*-this.maxD,this.commands=[],this.logs=[],this.bRender=!0,this.highlightColor=new THREE.Color(16776960),this.sphereGeometry=new THREE.SphereGeometry(1,32,32),this.boxGeometry=new THREE.BoxGeometry(1,1,1),this.cylinderGeometry=new THREE.CylinderGeometry(1,1,1,32,1),this.cylinderGeometryOutline=new THREE.CylinderGeometry(1,1,1,32,1,!0),this.sphereRadius=1.5,this.cylinderRadius=.4,this.linewidth=1,this.curveWidth=3,this.helixSheetWidth=1.3,this.coilWidth=.3,this.thickness=.4,this.axisDIV=5,this.strandDIV=6,this.tubeDIV=8,this.LABELSIZE=40,this.nucleicAcidStrandDIV=6,this.nucleicAcidWidth=.8,this.options={camera:"perspective",background:"black",color:"spectrum",sidechains:"nothing",secondary:"cylinder & plate",surface:"Van der Waals surface",wireframe:"no",opacity:"0.8",ligands:"stick",water:"nothing",ions:"sphere",hbonds:"no",labels:"no",lines:"no",rotationcenter:"molecule center",axis:"no",picking:"no",nucleotides:"nucleotide cartoon",showsurface:"no"},this._zoomFactor=1,this.mouseChange=new THREE.Vector2(0,0),this.quaternion=new THREE.Quaternion(0,0,0,1);var t=this;this.container.bind("contextmenu",function(e){e.preventDefault()}),t.typetext=!1,$(document).bind("keydown",function(e){if(t.controls&&(t.bStopRotate=!0,$("input, textarea").focus(function(){t.typetext=!0}),$("input, textarea").blur(function(){t.typetext=!1}),!t.typetext)){if(90===e.keyCode){var o={};t.camera===t.perspectiveCamera?o._zoomFactor=.9:t.camera===t.orthographicCamera&&(t._zoomFactor<.1?t._zoomFactor=.1:t._zoomFactor>1&&(t._zoomFactor=1),o._zoomFactor=.9*t._zoomFactor,o._zoomFactor<.1&&(o._zoomFactor=.1)),o.update=!0,t.controls.update(o)}else if(88===e.keyCode){var o={};t.camera===t.perspectiveCamera?o._zoomFactor=1.1:t.camera===t.orthographicCamera&&(t._zoomFactor>20?t._zoomFactor=20:t._zoomFactor<1&&(t._zoomFactor=1),o._zoomFactor=1.03*t._zoomFactor,o._zoomFactor>20&&(o._zoomFactor=20)),o.update=!0,t.controls.update(o)}else if(76===e.keyCode){var i=new THREE.Vector3(0,1,0),r=-5/180*Math.PI;i.applyQuaternion(t.camera.quaternion).normalize();var n=new THREE.Quaternion;n.setFromAxisAngle(i,-r);var o={};o.quaternion=n,o.update=!0,t.controls.update(o)}else if(74===e.keyCode){var i=new THREE.Vector3(0,1,0),r=5/180*Math.PI;i.applyQuaternion(t.camera.quaternion).normalize();var n=new THREE.Quaternion;n.setFromAxisAngle(i,-r);var o={};o.quaternion=n,o.update=!0,t.controls.update(o)}else if(73===e.keyCode){var i=new THREE.Vector3(1,0,0),r=-5/180*Math.PI;i.applyQuaternion(t.camera.quaternion).normalize();var n=new THREE.Quaternion;n.setFromAxisAngle(i,-r);var o={};o.quaternion=n,o.update=!0,t.controls.update(o)}else if(77===e.keyCode){var i=new THREE.Vector3(1,0,0),r=5/180*Math.PI;i.applyQuaternion(t.camera.quaternion).normalize();var n=new THREE.Quaternion;n.setFromAxisAngle(i,-r);var o={};o.quaternion=n,o.update=!0,t.controls.update(o)}else if(37===e.keyCode){e.preventDefault();var s=new THREE.Vector2(0,0);s.x-=.01;var o={};o.mouseChange=s,o.update=!0,t.controls.update(o)}else if(39===e.keyCode){e.preventDefault();var s=new THREE.Vector2(0,0);s.x+=.01;var o={};o.mouseChange=s,o.update=!0,t.controls.update(o)}else if(38===e.keyCode){e.preventDefault();var s=new THREE.Vector2(0,0);s.y-=.01;var o={};o.mouseChange=s,o.update=!0,t.controls.update(o)}else if(40===e.keyCode){e.preventDefault();var s=new THREE.Vector2(0,0);s.y+=.01;var o={};o.mouseChange=s,o.update=!0,t.controls.update(o)}t.render()}}),this.container.bind("mouseup touchend",function(e){t.isDragging=!1}),this.container.bind("mousedown touchstart",function(e){if(e.preventDefault(),t.scene){t.bStopRotate=!0;var o=e.pageX,i=e.pageY;if(e.originalEvent.targetTouches&&e.originalEvent.targetTouches[0]&&(o=e.originalEvent.targetTouches[0].pageX,i=e.originalEvent.targetTouches[0].pageY),t.isDragging=!0,t.picking){t.mouse.x=(o-t.container.offset().left)/t.container.width()*2-1,t.mouse.y=2*-((i-t.container.offset().top)/t.container.height())+1;var r=new THREE.Vector3;r.x=t.mouse.x,r.y=t.mouse.y,this.camera_z>0?r.z=-1:r.z=1,t.camera===t.perspectiveCamera?(this.camera_z>0?r.z=-1:r.z=1,r.unproject(t.camera),t.raycaster.set(t.camera.position,r.sub(t.camera.position).normalize())):t.camera===t.orthographicCamera&&(this.camera_z>0?r.z=1:r.z=-1,r.unproject(t.camera),t.raycaster.set(r,new THREE.Vector3(0,0,-1).transformDirection(t.camera.matrixWorld)));var n=t.raycaster.intersectObjects(t.objects);if(n.length>0){n[0].point.sub(t.mdl.position);for(var s=1,a=t.getAtomsFromPosition(n[0].point,s);!a&&10>s;)++s,a=t.getAtomsFromPosition(n[0].point,s);a?(t.pickpair?(t.pickedatomNum%2===0?t.pickedatom=a:t.pickedatom2=a,++t.pickedatomNum):t.pickedatom=a,t.showPicking(a)):console.log("No atoms were found in 10 andstrom range")}}t.controls.handleResize(),t.controls.update(),t.render()}}),this.container.bind("mousemove touchmove",function(e){e.preventDefault(),t.scene&&t.isDragging&&(t.controls.handleResize(),t.controls.update(),t.render())}),this.container.bind("mousewheel",function(e){e.preventDefault(),t.scene&&(t.bStopRotate=!0,t.controls.handleResize(),t.controls.update(),t.render())}),this.container.bind("DOMMouseScroll",function(e){e.preventDefault(),t.scene&&(t.bStopRotate=!0,t.controls.handleResize(),t.controls.update(),t.render())})};iCn3D.prototype={constructor:iCn3D,setOutlineColor:function(e){var t={outline:{vertex_shader:["uniform float offset;","void main() {","vec4 pos = modelViewMatrix * vec4( position + normal * offset, 1.0 );","gl_Position = projectionMatrix * pos;","}"].join("\n"),fragment_shader:["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}};"yellow"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"green"===e?t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 0.0, 1.0, 0.0, 1.0 );","}"].join("\n"):"red"===e&&(t.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}"].join("\n"));var o={offset:{type:"f",value:.5}},i=t.outline,r=new THREE.ShaderMaterial({uniforms:o,vertexShader:i.vertex_shader,fragmentShader:i.fragment_shader,depthTest:!1,depthWrite:!1,needsUpdate:!0});return r},setWidthHeight:function(e,t){this.renderer.setSize(e,t),this.container.widthInv=1/e,this.container.heightInv=1/t,this.container.whratio=e/t},nucleotidesArray:["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU"],ionsArray:[" NA"," MG"," AL"," CA"," TI"," MN"," FE"," NI"," CU"," ZN"," AG"," BA","  F"," CL"," BR","  I"],vdwRadii:{H:1.08,HE:1.34,LI:1.75,BE:2.05,B:1.47,C:1.49,N:1.41,O:1.4,F:1.39,NE:1.68,NA:1.84,MG:2.05,AL:2.11,SI:2.07,P:1.92,S:1.82,CL:1.83,AR:1.93,K:2.05,CA:2.21,SC:2.16,TI:1.87,V:1.79,CR:1.89,MN:1.97,FE:1.94,CO:1.92,NI:1.84,CU:1.86,ZN:2.1,GA:2.08,GE:2.15,AS:2.06,SE:1.93,BR:1.98,KR:2.12,RB:2.16,SR:2.24,Y:2.19,ZR:1.86,NB:2.07,MO:2.09,TC:2.09,RU:2.07,RH:1.95,PD:2.02,AG:2.03,CD:2.3,IN:2.36,SN:2.33,SB:2.25,TE:2.23,I:2.23,XE:2.21,CS:2.22,BA:2.51,LA:2.4,CE:2.35,PR:2.39,ND:2.29,PM:2.36,SM:2.29,EU:2.33,GD:2.37,TB:2.21,DY:2.29,HO:2.16,ER:2.35,TM:2.27,YB:2.42,LU:2.21,HF:2.12,TA:2.17,W:2.1,RE:2.17,OS:2.16,IR:2.02,PT:2.09,AU:2.17,HG:2.09,TL:2.35,PB:2.32,BI:2.43,PO:2.29,AT:2.36,RN:2.43,FR:2.56,RA:2.43,AC:2.6,TH:2.37,PA:2.43,U:2.4,NP:2.21,PU:2.56,AM:2.56,CM:2.56,BK:2.56,CF:2.56,ES:2.56,FM:2.56},covalentRadii:{H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69},atomColors:{H:new THREE.Color(16777215),He:new THREE.Color(16761035),HE:new THREE.Color(16761035),Li:new THREE.Color(11674146),LI:new THREE.Color(11674146),B:new THREE.Color(65280),C:new THREE.Color(13158600),N:new THREE.Color(9408511),O:new THREE.Color(15728640),F:new THREE.Color(14329120),Na:new THREE.Color(255),NA:new THREE.Color(255),Mg:new THREE.Color(2263842),MG:new THREE.Color(2263842),Al:new THREE.Color(8421520),AL:new THREE.Color(8421520),Si:new THREE.Color(14329120),SI:new THREE.Color(14329120),P:new THREE.Color(16753920),S:new THREE.Color(16762930),Cl:new THREE.Color(65280),CL:new THREE.Color(65280),Ca:new THREE.Color(8421520),CA:new THREE.Color(8421520),Ti:new THREE.Color(8421520),TI:new THREE.Color(8421520),Cr:new THREE.Color(8421520),CR:new THREE.Color(8421520),Mn:new THREE.Color(8421520),MN:new THREE.Color(8421520),Fe:new THREE.Color(16753920),FE:new THREE.Color(16753920),Ni:new THREE.Color(10824234),NI:new THREE.Color(10824234),Cu:new THREE.Color(10824234),CU:new THREE.Color(10824234),Zn:new THREE.Color(10824234),ZN:new THREE.Color(10824234),Br:new THREE.Color(10824234),BR:new THREE.Color(10824234),Ag:new THREE.Color(8421520),AG:new THREE.Color(8421520),I:new THREE.Color(10494192),Ba:new THREE.Color(16753920),BA:new THREE.Color(16753920),Au:new THREE.Color(14329120),AU:new THREE.Color(14329120)},defaultAtomColor:new THREE.Color(13421772),stdChainColors:[new THREE.Color(3329330),new THREE.Color(2003199),new THREE.Color(16416882),new THREE.Color(16753920),new THREE.Color(52945),new THREE.Color(16738740),new THREE.Color(65280),new THREE.Color(255),new THREE.Color(16711680),new THREE.Color(16776960),new THREE.Color(65535),new THREE.Color(16711935),new THREE.Color(3978097),new THREE.Color(4620980),new THREE.Color(13458524),new THREE.Color(16770229),new THREE.Color(11529966),new THREE.Color(15631086),new THREE.Color(25600),new THREE.Color(139),new THREE.Color(9109504),new THREE.Color(13468991),new THREE.Color(35723),new THREE.Color(9699539)],backgroundColors:{black:new THREE.Color(0),grey:new THREE.Color(13421772),white:new THREE.Color(16777215)},residueColors:{ALA:new THREE.Color(13158600),ARG:new THREE.Color(1334015),ASN:new THREE.Color(56540),ASP:new THREE.Color(15075850),CYS:new THREE.Color(15132160),GLN:new THREE.Color(56540),GLU:new THREE.Color(15075850),GLY:new THREE.Color(15461355),HIS:new THREE.Color(8553170),ILE:new THREE.Color(1016335),LEU:new THREE.Color(1016335),LYS:new THREE.Color(1334015),MET:new THREE.Color(15132160),PHE:new THREE.Color(3289770),PRO:new THREE.Color(14456450),SER:new THREE.Color(16422400),THR:new THREE.Color(16422400),TRP:new THREE.Color(11819700),TYR:new THREE.Color(3289770),VAL:new THREE.Color(1016335),ASX:new THREE.Color(16738740),GLX:new THREE.Color(16738740)},defaultResidueColor:new THREE.Color(12492910),polarityColors:{ARG:new THREE.Color(13369344),HIS:new THREE.Color(13369344),LYS:new THREE.Color(13369344),ASP:new THREE.Color(13369344),GLU:new THREE.Color(13369344),SER:new THREE.Color(13369344),THR:new THREE.Color(13369344),ASN:new THREE.Color(13369344),GLN:new THREE.Color(13369344),TYR:new THREE.Color(13369344),GLY:new THREE.Color(52428),PRO:new THREE.Color(52428),ALA:new THREE.Color(52428),VAL:new THREE.Color(52428),LEU:new THREE.Color(52428),ILE:new THREE.Color(52428),MET:new THREE.Color(52428),PHE:new THREE.Color(52428),CYS:new THREE.Color(52428),TRP:new THREE.Color(52428)},ssColors:{helix:new THREE.Color(16711808),sheet:new THREE.Color(16762880),coil:new THREE.Color(6324479)},defaultBondColor:new THREE.Color(2200790),surfaces:{1:void 0,2:void 0,3:void 0,4:void 0},hasCovalentBond:function(e,t){var o=this.covalentRadii[e.elem]+this.covalentRadii[t.elem];return e.coord.distanceToSquared(t.coord)<1.3*o*o},init:function(){this.structures={},this.chains={},this.residues={},this.secondarys={},this.alignChains={},this.chainsSeq={},this.chainsColor={},this.chainsAnno={},this.chainsAnnoTitle={},this.alignChainsSeq={},this.alignChainsAnno={},this.alignChainsAnnoTitle={},this.displayAtoms={},this.highlightAtoms={},this.prevHighlightObjects=[],this.definedNames2Residues={},this.definedNames2Atoms={},this.definedNames2Descr={},this.definedNames2Command={},this.residueId2Name={},this.moleculeTitle="",this.atoms={},this.displayAtoms={},this.highlightAtoms={},this.proteins={},this.nucleotides={},this.nucleotidesP={},this.ligands={},this.ions={},this.water={},this.calphas={},this.hbondpoints=[],this.atomPrevColors={},this.style2atoms={},this.labels=[],this.lines=[],this.inputid={idtype:void 0,id:void 0},this.biomtMatrices=[],this.bAssembly=!1},loadPDB:function(e){var t=[],o=[],i=e.split("\n"),r={},n={};this.init();var s,a,c=[],h=[],l=[],d=[],p=[],u=[],m=0,v=1,E="",f="",g="",w={};for(var b in i){var y=i[b],T=y.substr(0,6);if("HEADER"===T){var R=y.substr(10,40),H=y.substr(62,4);this.moleculeTitle=R.trim()+" ("+H+")"}else if("HELIX "===T){for(var C,x=y.substr(19,1),S=parseInt(y.substr(21,4)),A=parseInt(y.substr(33,4)),_=S;A>=_;++_)C=x+"_"+_,d.push(C),_===S&&p.push(C),_===A&&u.push(C);t.push({chain:x,initialResidue:S,initialInscode:y.substr(25,1),terminalResidue:A,terminalInscode:y.substr(37,1)})}else if("SHEET "===T){for(var x=y.substr(21,1),S=parseInt(y.substr(22,4)),A=parseInt(y.substr(33,4)),_=S;A>=_;++_){var C=x+"_"+_;c.push(C),_===S&&h.push(C),_===A&&l.push(C)}o.push({chain:x,initialResidue:S,initialInscode:y.substr(26,1),terminalResidue:A,terminalInscode:y.substr(37,1)})}else if("HBOND "===T){bCalculateHbond=!1;var M=(y.substr(6,1),y.substr(8,4).replace(/ /g,""),y.substr(14,4).replace(/ /g,""),y.substr(18,1),y.substr(20,4).replace(/ /g,""),y.substr(25,4).replace(/ /g,""),parseFloat(y.substr(30,8))),O=parseFloat(y.substr(38,8)),k=parseFloat(y.substr(46,8)),z=parseFloat(y.substr(54,8)),L=parseFloat(y.substr(62,8)),V=parseFloat(y.substr(70,8));y.substr(78,8).replace(/ /g,"");this.hbondpoints.push(new THREE.Vector3(M,O,k)),this.hbondpoints.push(new THREE.Vector3(z,L,V))}else if("REMARK"===T){var j=parseInt(y.substr(7,3));if(350==j&&"BIOMT"==y.substr(13,5)){var P=parseInt(y[18])-1,F=parseInt(y.substr(21,2));void 0==this.biomtMatrices[F]&&(this.biomtMatrices[F]=(new THREE.Matrix4).identity()),this.biomtMatrices[F].elements[P]=parseFloat(y.substr(24,9)),this.biomtMatrices[F].elements[P+4]=parseFloat(y.substr(34,9)),this.biomtMatrices[F].elements[P+8]=parseFloat(y.substr(44,9)),this.biomtMatrices[F].elements[P+12]=parseFloat(y.substr(54,10))}}else if("ENDMDL"===T)++v;else if("JRNL  "===T)"PMID"===y.substr(12,4)&&(this.pmid=y.substr(19).trim());else if("ATOM  "===T||"HETATM"===T){var D=y.substr(16,1);++m;var N=parseInt(y.substr(6,5));w[N]=m;var I=y.substr(76,2).replace(/ /g,"");""===I&&(I=y.substr(12,2).replace(/ /g,""));var B=y.substr(21,1);""===B&&(B=1);var G=parseInt(y.substr(22,4)),q=y.substr(12,4).replace(/ /g,""),C=B+"_"+G,W=parseFloat(y.substr(30,8)),Y=parseFloat(y.substr(38,8)),U=parseFloat(y.substr(46,8)),X=y.substr(17,3),Q=new THREE.Vector3(W,Y,U),Z={het:"H"===T[0],serial:m,name:q,alt:D,resn:X,structure:v,chain:B,resi:G,coord:Q,b:parseFloat(y.substr(60,8)),elem:I,bonds:[],ss:"coil",ssbegin:!1,ssend:!1};this.atoms[m]=Z,this.displayAtoms[m]=1,this.highlightAtoms[m]=1,-1!==$.inArray(C,d)?(this.atoms[m].ss="helix",-1!==$.inArray(C,p)&&(this.atoms[m].ssbegin=!0),-1!==$.inArray(C,u)&&(this.atoms[m].ssend=!0)):-1!==$.inArray(C,c)&&(this.atoms[m].ss="sheet",-1!==$.inArray(C,h)&&(this.atoms[m].ssbegin=!0),-1!==$.inArray(C,l)&&(this.atoms[m].ssend=!0)),s=v+"_"+B,a=s+"_"+G;var K="-";if("helix"===this.atoms[m].ss?K="H":"sheet"===this.atoms[m].ss?K="E":this.atoms[m].het||(K="C"),this.secondarys[a]=K,a!==f){var J=this.residueName2Abbr(X);if(this.residueId2Name[a]=J,1!==m&&(this.residues[f]=n),n={},s!==E){1!==m&&(this.chains[E]=this.unionHash2Atoms(this.chains[E],r)),r={},void 0===this.structures[v.toString()]&&(this.structures[v.toString()]=[]),this.structures[v.toString()].push(s),void 0===this.chainsSeq[s]&&(this.chainsSeq[s]=[]),void 0===this.chainsAnno[s]&&(this.chainsAnno[s]=[]),void 0===this.chainsAnno[s][0]&&(this.chainsAnno[s][0]=[]),void 0===this.chainsAnno[s][1]&&(this.chainsAnno[s][1]=[]),void 0===this.chainsAnnoTitle[s]&&(this.chainsAnnoTitle[s]=[]),void 0===this.chainsAnnoTitle[s][0]&&(this.chainsAnnoTitle[s][0]=[]),void 0===this.chainsAnnoTitle[s][1]&&(this.chainsAnnoTitle[s][1]=[]);var ee={};ee.resi=G,ee.name=J,this.chainsSeq[s].push(ee);var te="";G%10===0&&(te=G.toString()),this.chainsAnno[s][0].push(te),this.chainsAnno[s][1].push(K),this.chainsAnnoTitle[s][0].push(""),this.chainsAnnoTitle[s][1].push("SS")}else{var ee={};ee.resi=G,ee.name=J,this.chainsSeq[s].push(ee);var te="";G%10===0&&(te=G.toString()),this.chainsAnno[s][0].push(te),this.chainsAnno[s][1].push(K)}}r[m]=1,n[m]=1,g=T,E=s,f=a}else if("CONECT"===T)for(var oe=parseInt(y.substr(6,5)),_=0;4>_;++_){var ie=parseInt(y.substr([11,16,21,26][_],5));isNaN(ie)||void 0!==this.atoms[w[oe]]&&this.atoms[w[oe]].bonds.push(w[ie])}else"TER   "===T&&++m}i=null;var J=this.residueName2Abbr(X);this.chains[s]=r,this.residues[a]=n;var re,ne,se=[],ae=this,ce=function(e){for(var t=se.length,o=0;t>o;++o){for(var i=se[o],r=o+1;t>r;++r){var n=se[r];i.alt===n.alt&&ae.hasCovalentBond(i,n)&&(i.bonds.push(n.serial),n.bonds.push(i.serial))}e&&e(i)}},he=new THREE.Vector3(9999,9999,9999),le=new THREE.Vector3(-9999,-9999,-9999),de=new THREE.Vector3,pe=0;for(var b in this.atoms){var q=this.atoms[b],Q=q.coord;de.add(Q),he.min(Q),le.max(Q),++pe,q.het?q.het&&("HOH"===q.resn||"WAT"===q.resn?this.water[q.serial]=1:-1!==$.inArray(q.resn,this.ionsArray)?this.ions[q.serial]=1:this.ligands[q.serial]=1):-1!==$.inArray(q.resn,this.nucleotidesArray)?(this.nucleotides[q.serial]=1,"P"===q.name&&(this.nucleotidesP[q.serial]=1)):(this.proteins[q.serial]=1,"CA"===q.name&&(this.calphas[q.serial]=1)),(re!==q.chain||ne!==q.resi)&&(ce(function(e){("C"===e.name&&"N"===q.name||"O3'"===e.name&&"P"===q.name)&&ae.hasCovalentBond(e,q)&&(e.bonds.push(q.serial),q.bonds.push(e.serial))}),re=q.chain,ne=q.resi,se.length=0),se.push(q)}ce(),this.pmin=he,this.pmax=le,this.cnt=pe,this.maxD=this.pmax.distanceTo(this.pmin),this.center=de.multiplyScalar(1/this.cnt),this.maxD<25&&(this.maxD=25)},cloneHash:function(e,t){for(var o in e)t[o]=e[o]},residueName2Abbr:function(e){switch(void 0!==e&&" "!==e.charAt(0)&&" "===e.charAt(1)&&(e=e.charAt(0)),e){case"  A":return"A";case"  C":return"C";case"  G":return"G";case"  T":return"T";case"  U":return"U";case"  I":return"I";case"ALA":return"A";case"ARG":return"R";case"ASN":return"N";case"ASP":return"D";case"CYS":return"C";case"GLU":return"E";case"GLN":return"Q";case"GLY":return"G";case"HIS":return"H";case"ILE":return"I";case"LEU":return"L";case"LYS":return"K";case"MET":return"M";case"PHE":return"F";case"PRO":return"P";case"SER":return"S";case"THR":return"T";case"TRP":return"W";case"TYR":return"Y";case"VAL":return"V";case"SEC":return"U";case"PYL":return"O";default:return e}},calculateLigandHbonds:function(e,t,o){if(0!==Object.keys(e).length&&0!==Object.keys(t).length){var i,r={},n=o*o;for(var s in e){var a=e[s];("N"===a.elem||"O"===a.elem||"F"===a.elem)&&(i=a.structure+"_"+a.chain+"_"+a.resi+"_"+a.name,r[i]=a)}this.highlightAtoms={};for(var s in t){var a=t[s];if("N"===a.elem||"O"===a.elem||"F"===a.elem){i=a.structure+"_"+a.chain+"_"+a.resi+"_"+a.name;for(var c in r){var h=Math.abs(a.coord.x-r[c].coord.x);if(!(h>o)){var l=Math.abs(a.coord.y-r[c].coord.y);if(!(l>o)){var d=Math.abs(a.coord.z-r[c].coord.z);if(!(d>o)){var p=h*h+l*l+d*d;if(!(p>n)){var u=c.indexOf("_"),m=c.lastIndexOf("_"),v=c.substr(0,u),E=c.substr(u+1,m-u-1);m=E.lastIndexOf("_");var f=E.substr(0,m),g=E.substr(m+1);this.hbondpoints.push(a.coord),this.hbondpoints.push(r[c].coord),this.highlightAtoms=this.unionHash(this.highlightAtoms,this.residues[v+"_"+f+"_"+g])}}}}}}}}},createSphere:function(e,t,o,i,r){var n;if(void 0===t&&(t=.8),void 0===o&&(o=!1),void 0===i&&(i=1),2===r){i>.9?i=1.5:.5>i&&(i=1);var s=this.highlightColor;n=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:s}))}else if(1===r)n=new THREE.Mesh(this.sphereGeometry,this.matShader);else{var s=e.color;n=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:s}))}n.scale.x=n.scale.y=n.scale.z=o?t:(this.vdwRadii[e.elem]||t)*(i?i:1),n.position.copy(e.coord),this.mdl.add(n),1===r||2===r?this.prevHighlightObjects.push(n):this.objects.push(n)},createBox:function(e,t,o,i,r,n){var s;void 0===t&&(t=.8),void 0===o&&(o=!1),void 0===i&&(i=.8),n?(void 0===r&&(r=this.highlightColor),s=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:r}))):(void 0===r&&(r=e.color),s=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:r}))),s.scale.x=s.scale.y=s.scale.z=o?t:(this.vdwRadii[e.elem]||t)*(i?i:1),s.position.copy(e.coord),this.mdl.add(s),n?this.prevHighlightObjects.push(s):this.objects.push(s)},createCylinder:function(e,t,o,i,r){var n;2===r?(n=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:i})),o*=1.5):n=1===r?new THREE.Mesh(this.cylinderGeometryOutline,this.matShader):new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:i})),n.position.copy(e).add(t).multiplyScalar(.5),n.matrixAutoUpdate=!1,n.lookAt(e),n.updateMatrix(),n.matrix.multiply((new THREE.Matrix4).makeScale(o,o,e.distanceTo(t))).multiply((new THREE.Matrix4).makeRotationX(.5*Math.PI)),this.mdl.add(n),1===r||2===r?this.prevHighlightObjects.push(n):this.objects.push(n)},createRepresentationSub:function(e,t,o){new THREE.Geometry;for(var i in e){var r=e[i];t&&t(r);for(var n in r.bonds){var s=this.atoms[r.bonds[n]];void 0===s||s.serial<r.serial||o&&o(r,s)}}},createSphereRepresentation:function(e,t,o,i,r){var n=this;this.createRepresentationSub(e,function(e){n.createSphere(e,t,o,i,r)})},createBoxRepresentation_P_CA:function(e,t,o){var i=this;this.createRepresentationSub(e,function(e){("CA"===e.name||"P"===e.name)&&i.createBox(e,void 0,void 0,t,void 0,o)})},createStickRepresentation:function(e,t,o,i,r){var n=this;2!==r?this.createRepresentationSub(e,function(e){n.createSphere(e,t,!i,i,r)},function(e,t){if(e.color===t.color)n.createCylinder(e.coord,t.coord,o,e.color,r);else{var i=e.coord.clone().add(t.coord).multiplyScalar(.5);n.createCylinder(e.coord,i,o,e.color,r),n.createCylinder(t.coord,i,o,t.color,r)}}):2===r&&this.createBoxRepresentation_P_CA(e,1.2,r)},createLineRepresentation:function(e,t){var o=new THREE.Geometry;if(this.createRepresentationSub(e,void 0,function(e,t){if(e.color===t.color)o.vertices.push(e.coord),o.vertices.push(t.coord),o.colors.push(e.color),o.colors.push(t.color);else{var i=e.coord.clone().add(t.coord).multiplyScalar(.5);o.vertices.push(e.coord),o.vertices.push(i),o.vertices.push(t.coord),o.vertices.push(i),o.colors.push(e.color),o.colors.push(e.color),o.colors.push(t.color),o.colors.push(t.color)}}),2!==t){var i;1===t||(i=new THREE.Line(o,new THREE.LineBasicMaterial({linewidth:this.linewidth,vertexColors:!0}),THREE.LinePieces)),this.mdl.add(i),1===t?this.prevHighlightObjects.push(i):this.objects.push(i)}else 2===t&&this.createBoxRepresentation_P_CA(e,.8,t)},subdivide:function(e,t,o,i){var r=[],n=[],s=new Array;s.push(e[0]);for(var a=1,c=e.length-1;c>a;++a){var h=e[a],l=e[a+1];s.push(h.smoothen?h.clone().add(l).multiplyScalar(.5):h)}s.push(e[e.length-1]);
for(var d=[],p=[],a=-1,u=s.length,m=1/t;u-3>=a;++a){var h=s[-1===a?0:a],l=s[a+1],v=s[a+2],E=s[a===u-3?u-1:a+3],f=v.clone().sub(h).multiplyScalar(.5),g=E.clone().sub(l).multiplyScalar(.5);a>-1&&void 0!==o&&o[a+1]&&(r=r.concat(d),n=n.concat(p)),d=[],p=[];for(var w=0;t>w;++w){var b=m*w,y=l.x+b*f.x+b*b*(-3*l.x+3*v.x-2*f.x-g.x)+b*b*b*(2*l.x-2*v.x+f.x+g.x),T=l.y+b*f.y+b*b*(-3*l.y+3*v.y-2*f.y-g.y)+b*b*b*(2*l.y-2*v.y+f.y+g.y),R=l.z+b*f.z+b*b*(-3*l.z+3*v.z-2*f.z-g.z)+b*b*b*(2*l.z-2*v.z+f.z+g.z);o?(o[a+1]&&w<=parseInt(t/2)&&(r.push(new THREE.Vector3(y,T,R)),n.push(o[a+1])),o[a+2]&&w>parseInt(t/2)&&(d.push(new THREE.Vector3(y,T,R)),p.push(o[a+2]))):(r.push(new THREE.Vector3(y,T,R)),n.push(a+1))}}return(!o||o[a+1])&&(r=r.concat(d),n=n.concat(p),r.push(s[s.length-1]),n.push(s.length-1)),points_positions=[],points_positions.push(r),points_positions.push(n),points_positions},createCurveSubArrow:function(e,t,o,i,r,n,s,a,c,h,l){var d=[],p=[];d.push(e),p.push(a),this.prepareStrand(d,p,t,o,i,void 0,r,n,s,c,h,!1,l)},createCurveSub:function(e,t,o,i,r,n,s,a,c){if(0!==e.length){i=i||5;var h;if(h=s?e:this.subdivide(e,i,a,r)[0],0!==h.length){var l=new THREE.Geometry;if(2===r&&n)for(var d=0,p=1/i;d<h.length;++d)h[d].addScalar(.6),l.vertices.push(h[d]),l.colors.push(new THREE.Color(o[0===d?0:Math.round((d-1)*p)]));else if(1===r){var u=this.coilWidth/2,m=32,v=!1;if(h.length>1)if(void 0!==c)for(var E,f,g=[],d=0,w=h.length;w>d;++d){if(E=c[d],E!==f&&E!==f+1&&void 0!==f||d===w-1){var b=new THREE.TubeGeometry(new THREE.SplineCurve3(g),g.length,u,m,v);mesh=new THREE.Mesh(b,this.matShader),this.mdl.add(mesh),this.prevHighlightObjects.push(mesh),g=[]}g.push(h[d]),f=E}else{var b=new THREE.TubeGeometry(new THREE.SplineCurve3(h),h.length,u,m,v);mesh=new THREE.Mesh(b,this.matShader),this.mdl.add(mesh),this.prevHighlightObjects.push(mesh)}}else for(var d=0,p=1/i;d<h.length;++d)l.vertices.push(h[d]),l.colors.push(new THREE.Color(o[0===d?0:Math.round((d-1)*p)]));var y=new THREE.Line(l,new THREE.LineBasicMaterial({linewidth:t,vertexColors:!0}),THREE.LineStrip);this.mdl.add(y),2===r?this.prevHighlightObjects.push(y):this.objects.push(y)}}},createLines:function(e){if(void 0!==e)for(var t in e){var o,i=e[t],r=i.position1,n=i.position2;if(i.color){var s=/^\#([0-9a-f]{6})$/i.exec(i.color);o=parseInt(s[1],16)}else o=16776960;var a=i.dashed?i.dashed:!1,c=.3;this.mdl.add(this.createSingleLine(r,n,o,a,c))}},createCylinderCurve:function(e,t,o,i,r){var n,s,a,c=null;for(a in e){var h=e[a];if(!h.het&&h.name===t){if(null!==c&&n===h.chain&&s+1===h.resi){var l=c.coord.clone().add(h.coord).multiplyScalar(.5);if(r)1===r&&(this.createCylinder(c.coord,l,o,c.color,r),this.createCylinder(l,h.coord,o,h.color,r),this.createSphere(h,o,!0,1,r));else if(i){var d=this.createSingleLine(c.coord,l,c.color,!1);this.mdl.add(d),this.objects.push(d),d=this.createSingleLine(l,h.coord,h.color,!1),this.mdl.add(d),this.objects.push(d)}else this.createCylinder(c.coord,l,o,c.color),this.createCylinder(l,h.coord,o,h.color),this.createSphere(h,o,!0,1)}c=h,n=h.chain,s=h.resi,2===r&&this.createBox(h,void 0,void 0,void 0,void 0,r)}}if(null!==c&&n===h.chain&&s+1===h.resi){var l=c.coord.add(h.coord).multiplyScalar(.5);if(r)1===r&&(this.createCylinder(c.coord,l,o,c.color,r),this.createCylinder(l,h.coord,o,h.color,r),this.createSphere(h,o,!0,1,r));else if(i){var d=this.createSingleLine(c.coord,l,c.color,!1);this.mdl.add(d),this.objects.push(d),d=this.createSingleLine(l,h.coord,h.color,!1),this.mdl.add(d),this.objects.push(d)}else this.createCylinder(c.coord,l,o,c.color),this.createCylinder(l,h.coord,o,h.color)}},prepareStrand:function(e,t,o,i,r,n,s,a,c,h,l,d,p){if(1!==h.length){r=r||this.axisDIV;for(var u,m,v,E,f=2/(c-1),g={},w=[],b=0,y=t.length;y>b;++b)g[b]=[];var T=this.subdivide(h,r)[0];if(1!==T.length){for(var b=0,y=h.length-2;y>b;++b){for(var R=0,H=t.length;H>R;++R)g[R].push(e[R][b]);w.push(i[b])}w.push(i[b]);for(var b=0,y=t.length;y>b;++b)u=-1+f*t[b],m=T.length-1-r,v=h.length-2,E=new THREE.Vector3(T[m].x+l[v].x*u,T[m].y+l[v].y*u,T[m].z+l[v].z*u),g[b].push(E);for(var C=[],b=0,y=t.length;y>b;++b){var x=this.subdivide(g[b],r,p,s);g[b]=x[0],0===b&&(C=x[1])}d?this.createStrip(g[0],g[1],w,r,n,s,!0,void 0,C):this.createCurveSub(g[0],o,w,r,s,a,!0,void 0,C);for(var b=0,y=t.length;y>b;++b)g[b]=[];w=[],C=[];for(var R=0,H=t.length;H>R;++R){g[R]=[];for(var b=r*(h.length-2),y=r*(h.length-1);p[parseInt(b/r)]&&y>b;b+=r)for(var S=parseInt(b/r),A=0;r>A;++A){var u=-1+f*t[R],_=1.8;u=u*_*(r-A)/r;var M=parseInt(b/r),E=new THREE.Vector3(T[b+A].x+l[M].x*u,T[b+A].y+l[M].y*u,T[b+A].z+l[M].z*u);E.smoothen=!0,g[R].push(E),0===R&&C.push(S)}var u=0,m=T.length-1,v=h.length-1,E=new THREE.Vector3(T[m].x+l[v].x*u,T[m].y+l[v].y*u,T[m].z+l[v].z*u);E.smoothen=!0,g[R].push(E),0===R&&C.push(m)}w.push(i[i.length-2]),w.push(i[i.length-1]),d?this.createStrip(g[0],g[1],w,r,n,s,!0,void 0,C):this.createCurveSub(g[0],o,w,r,s,a,!0,void 0,C)}}},createStripArrow:function(e,t,o,i,r,n,s,a,c,h,l,d){var p=[],u=[];p.push(e),p.push(t),u.push(a),u.push(c),this.prepareStrand(p,u,void 0,o,i,r,n,void 0,s,h,l,!0,d)},createStrip:function(e,t,o,i,r,n,s,a,c){if(!(e.length<2||(i=i||this.axisDIV,s||(e=this.subdivide(e,i,a,n)[0],t=this.subdivide(t,i,a,n)[0]),e.length<2))){for(var h,l,d,p,u,m=new THREE.Geometry,v=m.vertices,E=m.faces,f=0,g=e.length;g>f;++f)v.push(l=e[f]),v.push(l),v.push(d=t[f]),v.push(d),g-1>f&&(h=t[f].clone().sub(e[f]).cross(e[f+1].clone().sub(e[f])).normalize().multiplyScalar(r)),v.push(p=e[f].clone().add(h)),v.push(p),v.push(u=t[f].clone().add(h)),v.push(u);for(var w=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]],f=1,g=e.length,b=1/i;g>f;++f)for(var y=8*f,T=new THREE.Color(o[Math.round((f-1)*b)]),R=0;4>R;++R)E.push(new THREE.Face3(y+w[R][0],y+w[R][1],y+w[R][2],void 0,T)),E.push(new THREE.Face3(y+w[R][3],y+w[R][0],y+w[R][2],void 0,T));for(var H=v.length-8,f=0;4>f;++f)v.push(v[2*f]),v.push(v[H+2*f]);H+=8,E.push(new THREE.Face3(H,H+2,H+6,void 0,E[0].color)),E.push(new THREE.Face3(H+4,H,H+6,void 0,E[0].color)),E.push(new THREE.Face3(H+1,H+5,H+7,void 0,E[E.length-3].color)),E.push(new THREE.Face3(H+3,H+1,H+7,void 0,E[E.length-3].color)),m.computeFaceNormals(),m.computeVertexNormals(!1);var C;if(2===n)C=new THREE.Mesh(m,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(C),this.prevHighlightObjects.push(C);else if(1===n){var x=this.coilWidth/2,S=32,A=!1;if(void 0!==c)for(var _,M,O=[],k=[],f=0,z=e.length;z>f;++f){if(_=c[f],_!==M&&_!==M+1&&void 0!==M||f===z-1){var L=new THREE.TubeGeometry(new THREE.SplineCurve3(O),O.length,x,S,A);C=new THREE.Mesh(L,this.matShader),this.mdl.add(C),this.prevHighlightObjects.push(C);var V=new THREE.TubeGeometry(new THREE.SplineCurve3(k),k.length,x,S,A);C=new THREE.Mesh(V,this.matShader),this.mdl.add(C),this.prevHighlightObjects.push(C),O=[],k=[]}O.push(e[f]),k.push(t[f]),M=_}else{var L=new THREE.TubeGeometry(new THREE.SplineCurve3(e),e.length,x,S,A);C=new THREE.Mesh(L,this.matShader),this.mdl.add(C),this.prevHighlightObjects.push(C);var V=new THREE.TubeGeometry(new THREE.SplineCurve3(t),t.length,x,S,A);C=new THREE.Mesh(V,this.matShader),this.mdl.add(C),this.prevHighlightObjects.push(C)}}else C=new THREE.Mesh(m,new THREE.MeshPhongMaterial({metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(C),this.objects.push(C)}},createBrick:function(e,t){for(var o=new THREE.Geometry,i=0,r=e.length;r>i;++i)o.vertices.push(new THREE.Vector3(e[i][0],e[i][1],e[i][2]));o.faces=[new THREE.Face3(1,5,7,void 0,t),new THREE.Face3(1,7,3,void 0,t),new THREE.Face3(0,2,6,void 0,t),new THREE.Face3(0,6,4,void 0,t),new THREE.Face3(2,3,7,void 0,t),new THREE.Face3(2,7,6,void 0,t),new THREE.Face3(0,4,5,void 0,t),new THREE.Face3(0,5,1,void 0,t),new THREE.Face3(4,6,7,void 0,t),new THREE.Face3(4,7,5,void 0,t),new THREE.Face3(0,1,3,void 0,t),new THREE.Face3(0,3,2,void 0,t)],o.computeFaceNormals(),o.computeVertexNormals(!1);var n;n=new THREE.Mesh(o,new THREE.MeshPhongMaterial({metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(n),this.objects.push(n)},getFirstAtomObj:function(e){var t=Object.keys(e),o=t[0];return this.atoms[o]},getLastAtomObj:function(e){var t=Object.keys(e),o=t[t.length-1];return this.atoms[o]},createStrand:function(e,t,o,i,r,n,s,a,c){var h=i?!0:!1,l={};if(1===c||2===c){var d,p,u,m,v,E,f,g,w=0,b=Object.keys(e).length;this.cloneHash(e,l);for(var y in e){if(d=e[y].structure+"_"+e[y].chain,p=parseInt(e[y].resi),u=e[y],void 0===m&&(f=e[y]),d!==m&&void 0!==m||p!==v&&p!==v+1&&void 0!==v||w===b-1){d!==m&&void 0!==m||p!==v&&p!==v+1&&void 0!==v?g=E:w===b-1&&(g=u);var T=f.resi;if("coil"!==f.ss&&!f.ssbegin){for(var R=f.resi-1;R>0;--R){var H=f.structure+"_"+f.chain+"_"+R;if(!this.residues.hasOwnProperty(H))break;var C=this.getFirstAtomObj(this.residues[H]);if(C.ss===f.ss&&C.ssbegin){T=C.resi;break}}for(var R=T;R<f.resi;++R){var H=f.structure+"_"+f.chain+"_"+R;l=this.unionHash(l,this.hash2Atoms(this.residues[H]))}}var x=g.resi;if("coil"!==g.ss&&!g.ssend&&!g.notshow){for(var S=this.getLastAtomObj(this.chains[g.structure+"_"+g.chain]).resi,R=g.resi+1;S>=R;++R){var H=g.structure+"_"+g.chain+"_"+R;if(!this.residues.hasOwnProperty(H))break;var C=this.getFirstAtomObj(this.residues[H]);if(C.ss===g.ss&&C.ssend){x=C.resi;break}}for(var R=g.resi+1;x>=R;++R){var H=g.structure+"_"+g.chain+"_"+R;l=this.unionHash(l,this.hash2Atoms(this.residues[H]))}}g.notshow&&(g.notshow=void 0),f=u}m=d,v=p,E=u,++w}}else l=e;2===c&&(i?(i=!1,t=null,o=null,r=null,n=null,a=void 0):(i=!0,t=2,o=void 0,r=void 0,n=void 0,a=this.thickness)),t=t||this.strandDIV,o=o||this.axisDIV,r=r||this.coilWidth,s=s||!1,n=n||this.helixSheetWidth;for(var A={},_=0;t>_;++_)A[_]=[];var M,O,k,C,z=[],L=[],V=[],j=[],P=null,F=null,D=null,N=null,I=null,B=null,G=null,q=null,$=!1,W=null,Y=null,v=null,U=!1,X=!1,Q={};this.bCalphaOnly=!1;var w=0,Z=30,K=!1;for(var R in l){if(!(Z>w))break;if("CA"!==l[R].name){K=!0;break}++w}K||(this.bCalphaOnly=!0);var J=this.hash2Atoms(l),ee={};for(var R in J){var C=J[R];H=C.structure+"_"+C.chain+"_"+C.resi,ee[H]=1}var te=Object.keys(ee).length,oe=0,ie=0;for(var R in l){C=l[R];if(("O"===C.name||"CA"===C.name)&&!C.het&&("CA"===C.name&&(e.hasOwnProperty(R)&&("coil"===C.ss||C.ssend||C.ssbegin)&&(Q[R]=C),P=C.coord.clone(),D=C.color),"O"===C.name||this.bCalphaOnly&&"CA"===C.name)){"O"===C.name&&(F=C.coord.clone());var re=!0;if((M!==C.chain||O+1!==C.resi)&&(re=!1),C.ssend&&"sheet"===C.ss?U=!0:C.ssend&&"helix"===C.ss&&(X=!0),I){1===c||2===c?j.push(this.highlightColor):j.push(B),k="coil"!==q&&"coil"===C.ss?r:$&&C.ssbegin?r:"coil"===q?r:n;var ne;"O"===C.name?(ne=I.clone(),ne.sub(N)):this.bCalphaOnly&&"CA"===C.name&&(ne=new THREE.Vector3(Math.random(),Math.random(),Math.random())),ne.normalize(),ne.multiplyScalar(k),null!==G&&ne.dot(G)<0&&ne.negate(),G=ne;for(var se=0,ae=2/(t-1);t>se;++se){var ce=-1+ae*se,he=new THREE.Vector3(N.x+G.x*ce,N.y+G.y*ce,N.z+G.z*ce);s||"coil"===q||(he.smoothen=!0),A[se].push(he)}z.push(N),L.push(G),e.hasOwnProperty(Y)?(V.push(v),++ie):V.push(0),++oe}if((C.ssbegin||C.ssend||oe===te-1)&&A[0].length>0&&re){1===c||2===c?j.push(this.highlightColor):j.push(C.color),k=C.ssend&&"sheet"===C.ss?0:"coil"===q&&C.ssbegin?r:$&&C.ssbegin?r:"coil"===C.ss?r:n;var ne;"O"===C.name?(ne=F.clone(),ne.sub(P)):this.bCalphaOnly&&"CA"===C.name&&(ne=new THREE.Vector3(Math.random(),Math.random(),Math.random())),ne.normalize(),ne.multiplyScalar(k),null!==G&&ne.dot(G)<0&&ne.negate(),G=ne;for(var se=0,ae=2/(t-1);t>se;++se){var ce=-1+ae*se,he=new THREE.Vector3(P.x+G.x*ce,P.y+G.y*ce,P.z+G.z*ce);s||"coil"===q||(he.smoothen=!0),A[se].push(he)}W=C.serial,z.push(P),L.push(G),e.hasOwnProperty(W)?V.push(C.resi):V.push(0);for(var se=0;!i&&t>se;++se)U?this.createCurveSubArrow(A[se],1,j,o,c,h,t,se,z,L,V):this.createCurveSub(A[se],1,j,o,c,h,!1,V);if(i)if(U){var le=0,de=t-1;this.createStripArrow(A[0],A[t-1],j,o,a,c,t,le,de,z,L,V)}else X?this.createStrip(A[0],A[t-1],j,o,a,c,!1,V):2===c&&this.createStrip(A[0],A[t-1],j,o,a,c,!1,V);for(var _=0;t>_;++_)A[_]=[];j=[],z=[],L=[],V=[],U=!1,X=!1}if((M!==C.chain||O+1!==C.resi)&&A[0].length>0){for(var se=0;!i&&t>se;++se)U?this.createCurveSubArrow(A[se],1,j,o,c,h,t,se,z,L,V):X&&this.createCurveSub(A[se],1,j,o,c,h,!1,V);if(i)if(U){var le=0,de=t-1;this.createStripArrow(A[0],A[t-1],j,o,a,c,t,le,de,z,L,V)}else X&&this.createStrip(A[0],A[t-1],j,o,a,c,!1,V);for(var _=0;t>_;++_)A[_]=[];j=[],z=[],L=[],V=[],U=!1,X=!1}M=C.chain,O=C.resi,q=C.ss,$=C.ssend,Y=C.serial,v=C.resi,N=P,I=C.coord,B=D}}this.createTube(Q,"CA",.3,c)},createStrandBrick:function(e,t,o){for(var i=this.strandDIV,r=this.axisDIV,n=!1,s=this.helixSheetWidth,a={},c=0;i>c;++c)a[c]=[];for(var h=[],l=null,d=0;2>d;++d){var p=e.coords[d];h.push(new THREE.Color(t));var u=new THREE.Vector3(e.coords[2].x,e.coords[2].y,e.coords[2].z);u.normalize(),u.multiplyScalar(s),null!==l&&u.dot(l)<0&&u.negate(),l=u;for(var m=0,v=2/(i-1);i>m;++m){var E=-1+v*m,f=new THREE.Vector3(p.x+l.x*E,p.y+l.y*E,p.z+l.z*E);n||(f.smoothen=!0),a[m].push(f)}}this.createStrip(a[0],a[i-1],h,r,o)},createTubeSub:function(e,t,o,i){if(!(e.length<2)){for(var r,n=this.tubeDIV,s=this.axisDIV,a=1/n,c=1/s,h=new THREE.Geometry,l=this.subdivide(e,s)[0],d=new THREE.Vector3,p=0,u=l.length;u>p;++p){var m,v=(p-1)*c;if(0===p)m=o[0];else if(v%1===0)m=o[v];else{var E=Math.floor(v),f=v-E;m=o[E]*f+o[E+1]*(1-f)}var g,w,b;u-1>p?(g=l[p].clone().sub(l[p+1]),w=new THREE.Vector3(0,-g.z,g.y).normalize().multiplyScalar(m),b=g.clone().cross(w).normalize().multiplyScalar(m),d.dot(w)<0&&(w.negate(),b.negate()),d=w,r=b):(w=d,b=r);for(var y=0;n>y;++y){var T=2*Math.PI*a*y;h.vertices.push(l[p].clone().add(w.clone().multiplyScalar(Math.cos(T))).add(b.clone().multiplyScalar(Math.sin(T))))}}for(var R=0,p=0,u=l.length-1;u>p;++p){var H=new THREE.Color(t[Math.round((p-1)*c)]),C=0,x=h.vertices[R].clone().sub(h.vertices[R+n]).lengthSq(),S=h.vertices[R].clone().sub(h.vertices[R+n+1]).lengthSq();x>S&&(x=S,C=1);for(var y=0;n>y;++y)h.faces.push(new THREE.Face3(R+y,R+(y+C)%n+n,R+(y+1)%n,void 0,H)),h.faces.push(new THREE.Face3(R+(y+1)%n,R+(y+C)%n+n,R+(y+C+1)%n+n,void 0,H));R+=n}h.computeFaceNormals(),h.computeVertexNormals(!1);var A;A=2===i?new THREE.Mesh(h,new THREE.MeshPhongMaterial({transparent:!0,opacity:.5,metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})):1===i?new THREE.Mesh(h,this.matShader):new THREE.Mesh(h,new THREE.MeshPhongMaterial({metal:!1,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide})),this.mdl.add(A),1===i||2===i?this.prevHighlightObjects.push(A):this.objects.push(A)}},createTube:function(e,t,o,i){var r,n,s=[],a=[],c=[];for(var h in e){var l=e[h];if(l.name===t&&!l.het){(r!==l.chain||n+1!==l.resi)&&(2!==i&&this.createTubeSub(s,a,c,i),s=[],a=[],c=[]),s.push(l.coord),c.push(o||(l.b>0?.01*l.b:.3)),a.push(l.color),r=l.chain,n=l.resi;var d=1.2;2!==i||l.ssbegin||this.createBox(l,void 0,void 0,d,void 0,i)}}2!==i&&this.createTubeSub(s,a,c,i)},createCylinderHelix:function(e,t,o){var i,r,n,s=null,a={},c={};for(n in e){var h=e[n];h.het||(("helix"!==h.ss&&"sheet"!==h.ss||h.ssend||h.ssbegin)&&(a[h.serial]=h),"sheet"===h.ss&&(c[h.serial]=h),"CA"===h.name&&("helix"===h.ss&&h.ssend&&(null!==s&&i===h.chain&&r<h.resi&&(1===o||2===o?this.createCylinder(s.coord,h.coord,t,this.highlightColor,o):this.createCylinder(s.coord,h.coord,t,h.color)),s=null),null===s&&"helix"===h.ss&&h.ssbegin&&(s=h,i=h.chain,r=h.resi)))}1===o||2===o?(Object.keys(a).length>0&&this.createTube(a,"CA",.3,o),Object.keys(c).length>0&&this.createStrand(c,void 0,void 0,!0,0,this.helixSheetWidth,!1,2*this.thickness,o)):(Object.keys(a).length>0&&this.createTube(a,"CA",.3),Object.keys(c).length>0&&this.createStrand(c,void 0,void 0,!0,0,this.helixSheetWidth,!1,2*this.thickness))},createSurfaceRepresentation:function(e,t,o,i){var r,n=ProteinSurface({min:this.pmin,max:this.pmax,atoms:e,type:t}),s=n.verts,a=n.faces;r=new THREE.Geometry,r.vertices=s.map(function(e){var t=new THREE.Vector3(e.x,e.y,e.z);return t.atomid=e.atomid,t}),r.faces=a.map(function(e){return new THREE.Face3(e.a,e.b,e.c)}),n=null,r.computeFaceNormals(),r.computeVertexNormals(!1),r.colorsNeedUpdate=!0,r.faces.forEach(function(t){t.vertexColors=["a","b","c"].map(function(o){return e[r.vertices[t[o]].atomid].color})});var c=new THREE.Mesh(r,new THREE.MeshLambertMaterial({overdraw:this.overdraw,vertexColors:THREE.VertexColors,wireframe:o,opacity:i,transparent:!0}));this.mdl.add(c),r=null},drawNucleicAcidStick:function(e,t){var o,i,r,n=null,s=null;for(r in e){var a=e[r];void 0===a||a.het||((a.resi!==i||a.chain!==o)&&(null!==n&&null!==s&&this.createCylinder(new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z),new THREE.Vector3(s.coord.x,s.coord.y,s.coord.z),.3,n.color,t),n=null,s=null),"O3'"===a.name&&(n=a),"  A"===a.resn||"  G"===a.resn||" DA"===a.resn||" DG"===a.resn?"N1"===a.name&&(s=a):"N3"===a.name&&(s=a),i=a.resi,o=a.chain)}null!==n&&null!==s&&this.createCylinder(new THREE.Vector3(n.coord.x,n.coord.y,n.coord.z),new THREE.Vector3(s.coord.x,s.coord.y,s.coord.z),.3,n.color,t)},drawCartoonNucleicAcid:function(e,t,o,i){this.drawStrandNucleicAcid(e,2,t,!0,void 0,o,i)},drawStrandNucleicAcid:function(e,t,o,i,r,n,s){2===s&&(t=void 0,n=void 0),r=r||this.nucleicAcidWidth,o=o||this.axisDIV,t=t||this.nucleicAcidStrandDIV;var a,c,h,l=[];for(h=0;t>h;h++)l[h]=[];var d,p,u,m=[],v=null;for(a in e){var E=e[a];if(void 0!==E&&("O3'"===E.name||"OP2"===E.name)&&!E.het)if("O3'"===E.name){if(d!==E.chain||p+1!==E.resi){if(u&&v)for(c=0;t>c;c++){var f=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(u.x+v.x*f,u.y+v.y*f,u.z+v.z*f))}for(i&&this.createStrip(l[0],l[1],m,o,n,s),c=0;!n&&t>c;c++)this.createCurveSub(l[c],1,m,o,s);var l=[];for(h=0;t>h;h++)l[h]=[];m=[],v=null}u=new THREE.Vector3(E.coord.x,E.coord.y,E.coord.z),d=E.chain,p=E.resi,1===s||2===s?m.push(this.highlightColor):m.push(E.color)}else{if(!u){v=null;continue}var g=new THREE.Vector3(E.coord.x,E.coord.y,E.coord.z);for(g.sub(u),g.normalize().multiplyScalar(r),null!==v&&g.dot(v)<0&&g.negate(),v=g,c=0;t>c;c++){var f=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(u.x+v.x*f,u.y+v.y*f,u.z+v.z*f))}u=null}}if(u&&v)for(c=0;t>c;c++){var f=-1+2/(t-1)*c;l[c].push(new THREE.Vector3(u.x+v.x*f,u.y+v.y*f,u.z+v.z*f))}for(i&&this.createStrip(l[0],l[1],m,o,n,s),c=0;!n&&t>c;c++)this.createCurveSub(l[c],1,m,o,s)},drawSymmetryMates2:function(){if(void 0!==this.biomtMatrices){for(var e=1,t=this.center.clone(),o=0;o<this.biomtMatrices.length;o++){var i=this.biomtMatrices[o];if(void 0!==i){var r=i.toArray(),n=1;for(var s in r)0==s||5==s||10==s?1e3!=parseInt(1e3*r[s])&&(n=0):0!=s&&5!=s&&10!=s&&15!=s&&0!=parseInt(1e3*r[s])&&(n=0);if(!n){var a=this.mdl.clone();a.applyMatrix(i);var c=this.center.clone();c.applyMatrix4(i),t.add(c),this.mdl.add(a),++e}}}this.maxD*=Math.sqrt(e),this.mdl.position.add(this.center).sub(t.multiplyScalar(1/e)),this.setCamera()}},makeTextSprite:function(e,t){void 0===t&&(t={});var o=t.hasOwnProperty("fontface")?t.fontface:"Arial",i=t.hasOwnProperty("fontsize")?t.fontsize:18,r=t.hasOwnProperty("borderThickness")?t.borderThickness:4,n=1,s=t.hasOwnProperty("borderColor")?this.hexToRgb(t.borderColor,n):{r:0,g:0,b:0,a:1},a=t.hasOwnProperty("backgroundColor")?this.hexToRgb(t.backgroundColor,n):{r:0,g:0,b:0,a:.5};n=1;var c=t.hasOwnProperty("textColor")?this.hexToRgb(t.textColor,n):{r:255,g:255,b:0,a:1},h=document.createElement("canvas"),l=h.getContext("2d");l.font="Bold "+i+"px "+o;var d=l.measureText(e),p=d.width,u=l.measureText("M").width;l.fillStyle="rgba("+a.r+","+a.g+","+a.b+","+a.a+")",l.strokeStyle="rgba("+s.r+","+s.g+","+s.b+","+s.a+")",l.lineWidth=r,this.roundRect(l,r/2,r/2,1.1*(p+r),1.4*i+r,.3*u),l.fillStyle="rgba("+c.r+", "+c.g+", "+c.b+", 1.0)",l.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", 1.0)",l.fillText(e,r+.1*i,i+r);var m=new THREE.Texture(h);m.needsUpdate=!0;var v=!0,E=new THREE.SpriteMaterial({map:m,useScreenCoordinates:!1,depthTest:!v,depthWrite:!v}),f=new THREE.Sprite(E),g=this.maxD/100;return f.scale.set(16*g,8*g,1),f},hexToRgb:function(e,t){var o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16),a:t}:null},roundRect:function(e,t,o,i,r,n){e.beginPath(),e.moveTo(t+n,o),e.lineTo(t+i-n,o),e.quadraticCurveTo(t+i,o,t+i,o+n),e.lineTo(t+i,o+r-n),e.quadraticCurveTo(t+i,o+r,t+i-n,o+r),e.lineTo(t+n,o+r),e.quadraticCurveTo(t,o+r,t,o+r-n),e.lineTo(t,o+n),e.quadraticCurveTo(t,o,t+n,o),e.closePath(),e.fill(),e.stroke()},createLabelRepresentation:function(e){for(var t in e){var o=e[t],i=o.size?o.size:this.LABELSIZE,r=o.color?o.color:"#ffff00",n=o.background?o.background:"#cccccc",s=this.makeTextSprite(o.text,{fontsize:parseInt(i),textColor:r,borderColor:n,backgroundColor:n});s.position.set(o.position.x,o.position.y,o.position.z),this.mdl.add(s)}},getAtomsWithinAtom:function(e,t,o){var i=this.getExtent(t),r=(i[2][0]-i[0][0])*(i[2][0]-i[0][0])+(i[2][1]-i[0][1])*(i[2][1]-i[0][1])+(i[2][2]-i[0][2])*(i[2][2]-i[0][2]),n=(i[2][0]-i[1][0])*(i[2][0]-i[1][0])+(i[2][1]-i[1][1])*(i[2][1]-i[1][1])+(i[2][2]-i[1][2])*(i[2][2]-i[1][2]),s=r>n?r:n,a=Math.sqrt(s),c=(a+o)*(a+o),h={};for(var l in e){var d=e[l];if(!(d.serial in t||d.coord.x<i[0][0]-o||d.coord.x>i[1][0]+o||d.coord.y<i[0][1]-o||d.coord.y>i[1][1]+o||d.coord.z<i[0][2]-o||d.coord.z>i[1][2]+o)){var p=(d.coord.x-i[2][0])*(d.coord.x-i[2][0])+(d.coord.y-i[2][1])*(d.coord.y-i[2][1])+(d.coord.z-i[2][2])*(d.coord.z-i[2][2]);c>p&&(h[d.serial]=d)}}var u={};for(var l in t){var m=t[l],v=this.vdwRadii[m.elem]||this.defaultRadius;for(var E in h){var d=h[E],p=(d.coord.x-m.coord.x)*(d.coord.x-m.coord.x)+(d.coord.y-m.coord.y)*(d.coord.y-m.coord.y)+(d.coord.z-m.coord.z)*(d.coord.z-m.coord.z);c=(v+o)*(v+o),c>p&&(u[d.serial]=d)}}return u},getExtent:function(e){var t,o=ymin=zmin=9999,i=ymax=zmax=-9999,r=ysum=zsum=cnt=0;for(t in e){var n=e[t];cnt++,r+=n.coord.x,ysum+=n.coord.y,zsum+=n.coord.z,o=o<n.coord.x?o:n.coord.x,ymin=ymin<n.coord.y?ymin:n.coord.y,zmin=zmin<n.coord.z?zmin:n.coord.z,i=i>n.coord.x?i:n.coord.x,ymax=ymax>n.coord.y?ymax:n.coord.y,zmax=zmax>n.coord.z?zmax:n.coord.z}return[[o,ymin,zmin],[i,ymax,zmax],[r/cnt,ysum/cnt,zsum/cnt]]},getAtomsFromPosition:function(e,t){var o,i;(void 0===t||null===t)&&(t=1);for(o in this.atoms){var i=this.atoms[o];if(!(i.coord.x<e.x-t||i.coord.x>e.x+t||i.coord.y<e.y-t||i.coord.y>e.y+t||i.coord.z<e.z-t||i.coord.z>e.z+t))return i}return null},buildAxes:function(e){var t=new THREE.Object3D;t.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0+e,0,0),16711680,!1,.5)),t.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0-e,0,0),8388608,!0,.5)),t.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0+e,0),65280,!1,.5)),t.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0-e,0),32768,!0,.5)),t.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0+e),255,!1,.5)),t.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0-e),128,!0,.5)),this.scene.add(t)},createSingleLine:function(e,t,o,i,r){var n,s=new THREE.Geometry;n=i?new THREE.LineDashedMaterial({linewidth:1,color:o,dashSize:r,gapSize:r}):new THREE.LineBasicMaterial({linewidth:1,color:o}),s.vertices.push(e),s.vertices.push(t),i&&s.computeLineDistances();var a=new THREE.Line(s,n,THREE.LinePieces);return a},intersectHash:function(e,t){var o={};if(Object.keys(e).length<Object.keys(t).length)for(var i in e)void 0!==t&&t[i]&&(o[i]=e[i]);else for(var i in t)void 0!==e&&e[i]&&(o[i]=t[i]);return o},excludeHash:function(e,t){var o={};for(var i in e)i in t||(o[i]=e[i]);return o},unionHash:function(e,t){return jQuery.extend({},e,t)},intersectHash2Atoms:function(e,t){return this.hash2Atoms(this.intersectHash(e,t))},excludeHash2Atoms:function(e,t){return this.hash2Atoms(this.excludeHash(e,t))},unionHash2Atoms:function(e,t){return this.hash2Atoms(this.unionHash(e,t))},hash2Atoms:function(e){var t={};for(var o in e)t[o]=this.atoms[o];return t},centerAtoms:function(e){var t=new THREE.Vector3(9999,9999,9999),o=new THREE.Vector3(-9999,-9999,-9999),i=new THREE.Vector3,r=0;for(var n in e){var s=this.atoms[n],a=s.coord;i.add(a),t.min(a),o.max(a),++r}var c=o.distanceTo(t);return{center:i.multiplyScalar(1/r),maxD:c}},exportCanvas:function(){this.render(),window.open(this.renderer.domElement.toDataURL("image/png"))},applyPrevColor:function(){for(var e in this.atoms){var t=this.atoms[e];t.color=this.atomPrevColors[e]}},setColorByOptions:function(e,t,o){if(void 0!==o&&o)for(var i in t){var r=this.atoms[i];this.atomPrevColors[i]=r.color}else if(0===e.color.indexOf("#"))for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setStyle(e.color.toLowerCase()),this.atomPrevColors[i]=r.color}else switch(e.color.toLowerCase()){case"spectrum":var n=0,a=1/this.cnt;for(var i in t){var r=this.atoms[i];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:(new THREE.Color).setHSL(2/3*(1-n++*a),1,.45),this.atomPrevColors[i]=r.color}break;case"chain":var c=-1,h="",l=this.stdChainColors.length;for(var i in t){var r=this.atoms[i];r.chain!=h&&(++c,c%=l),r.color=this.stdChainColors[c],Object.keys(this.chainsColor).length>0&&this.updateChainsColor(r),this.atomPrevColors[i]=r.color,h=r.chain}break;case"secondary structure":for(var i in t){var r=this.atoms[i];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:this.ssColors[r.ss],this.atomPrevColors[i]=r.color}break;case"B factor":var d=this.getFirstAtomObj(this.atoms);if(!this.middB&&void 0!==d.b){var p=1e3,u=-1e3;for(var i in t){var r=this.atoms[i];p>parseFloat(r.b)&&(p=parseFloat(r.b)),u<parseFloat(r.b)&&(u=parseFloat(r.b))}this.middB=.5*(u+p),this.spanB=.5*(u-p),this.spanBinv=1/this.spanB}for(var i in t){var r=this.atoms[i];void 0!==r.b&&void 0!==this.middB&&(r.color=r.b<this.middB?(new THREE.Color).setRGB(1-(s=(this.middB-r.b)*this.spanBinv),1-s,1):(new THREE.Color).setRGB(1,1-(s=(r.b-this.middB)*this.spanBinv),1-s)),this.atomPrevColors[i]=r.color}break;case"residue":for(var i in t){var r=this.atoms[i];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:this.residueColors[r.resn]||this.defaultResidueColor,this.atomPrevColors[i]=r.color}break;case"polarity":for(var i in t){var r=this.atoms[i];r.color=r.het?this.atomColors[r.elem]||this.defaultAtomColor:this.polarityColors[r.resn]||this.defaultResidueColor,this.atomPrevColors[i]=r.color}break;case"atom":for(var i in t){var r=this.atoms[i];r.color=this.atomColors[r.elem]||this.defaultAtomColor,this.atomPrevColors[i]=r.color}break;case"white":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(16777215),this.atomPrevColors[i]=r.color}break;case"grey":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(8947848),this.atomPrevColors[i]=r.color}break;case"red":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(16711680),this.atomPrevColors[i]=r.color}break;case"green":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(65280),this.atomPrevColors[i]=r.color}break;case"blue":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(255),this.atomPrevColors[i]=r.color}break;case"magenta":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(16711935),this.atomPrevColors[i]=r.color}break;case"yellow":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(16776960),this.atomPrevColors[i]=r.color}break;case"cyan":for(var i in t){var r=this.atoms[i];r.color=(new THREE.Color).setHex(65535),this.atomPrevColors[i]=r.color}break;case"custom":}},updateChainsColor:function(e){var t=e.structure+"_"+e.chain;void 0!==this.chainsColor[t]&&(this.chainsColor[t]=e.color)},drawHelixBrick:function(e,t){for(var o in e)for(var i=0,r=e[o].length;r>i;++i)if("helix"===e[o][i].type){var n=1.6,s=new THREE.Color(t[o]),a=new THREE.Vector3(e[o][i].coords[0].x,e[o][i].coords[0].y,e[o][i].coords[0].z),c=new THREE.Vector3(e[o][i].coords[1].x,e[o][i].coords[1].y,e[o][i].coords[1].z);this.createCylinder(a,c,n,s)}else if("brick"===e[o][i].type){var h=e[o][i],s=t[o];this.createStrandBrick(h,s,this.thickness)}else if("coil"===e[o][i].type){var a=new THREE.Vector3(e[o][i].coords[0].x,e[o][i].coords[0].y,e[o][i].coords[0].z),c=new THREE.Vector3(e[o][i].coords[1].x,e[o][i].coords[1].y,e[o][i].coords[1].z),s=new THREE.Color(t[o]),l=this.createSingleLine(a,c,s,!1);this.mdl.add(l),this.objects.push(l)}},applyOptions:function(e){if(void 0===e&&(e=this.options),this.applyDisplayOptions(e,this.displayAtoms),"yes"===e.labels.toLowerCase()&&this.createLabelRepresentation(this.labels),"yes"===e.lines.toLowerCase()&&this.createLines(this.lines),"yes"===e.hbonds.toLowerCase()){var t="#FFFFFF";"black"!==e.background.toLowerCase()&&(t="#000000");for(var o=0,i=Math.floor(this.hbondpoints.length/2);i>o;o++){var r=(this.hbondpoints[2*o],this.hbondpoints[2*o+1],{});r.position1=this.hbondpoints[2*o],r.position2=this.hbondpoints[2*o+1],r.color=t,r.dashed=!0,this.lines.push(r)}this.createLines(this.lines)}switch(e.rotationcenter.toLowerCase()){case"molecule center":void 0!==this.center&&this.mdl.position.sub(this.center);break;case"pick center":void 0!==this.pickedatom&&this.mdl.position.sub(this.pickedatom.coord);break;case"display center":var n=this.centerAtoms(this.displayAtoms).center;this.mdl.position.sub(n);break;case"highlight center":var n=this.centerAtoms(this.highlightAtoms).center;this.mdl.position.sub(n)}switch(e.axis.toLowerCase()){case"yes":this.axis=!0,this.buildAxes(this.maxD/2);break;case"no":this.axis=!1}switch(e.picking.toLowerCase()){case"atom":this.picking=1;break;case"no":this.picking=0;break;case"residue":this.picking=2}switch(e.wireframe){case"yes":e.wireframe=!0;break;case"no":e.wireframe=!1}if(e.opacity=parseFloat(e.opacity),"yes"===e.showsurface.toLowerCase()){var s={};switch(s=this.hash2Atoms(this.highlightAtoms),e.surface.toLowerCase()){case"van der waals surface":this.createSurfaceRepresentation(s,1,e.wireframe,e.opacity);break;case"solvent excluded surface":this.createSurfaceRepresentation(s,2,e.wireframe,e.opacity);break;case"solvent accessible surface":this.createSurfaceRepresentation(s,3,e.wireframe,e.opacity);break;case"molecular surface":this.createSurfaceRepresentation(s,4,e.wireframe,e.opacity)}}},applyDisplayOptions:function(e,t,o){void 0===e&&(e=this.options);var i,r={},n={},s={};if(1===o){s=this.hash2Atoms(t);for(var a in s){var c=s[a];i=c.structure+"_"+c.chain+"_"+c.resi,r[i]=1}for(var a in r){var h=a.lastIndexOf("_"),l=a.substr(0,h+1),d=parseInt(a.substr(h+1)),p=l+(d-1).toString(),u=l+(d+1).toString();r.hasOwnProperty(p)||r.hasOwnProperty(p)||(n[a]=1)}if(1===Object.keys(s).length&&Object.keys(this.residues[i]).length>1&&"sphere"!==s[Object.keys(s)[0]].style&&"dot"!==s[Object.keys(s)[0]].style){if(void 0===this.bCid||!this.bCid)for(var a in s){var c=s[a],m=1;this.createBox(c,void 0,void 0,m,void 0,o)}}else for(var i in n){var c=this.getFirstAtomObj(this.residues[i]),p=c.structure+"_"+c.chain+"_"+parseInt(c.resi-1),u=c.structure+"_"+c.chain+"_"+parseInt(c.resi+1);if("cylinder & plate"===c.style&&"helix"===c.ss)for(var a in this.residues[i]){var c=this.atoms[a],m=1;this.createBox(c,void 0,void 0,m,void 0,o)}else if("ribbon"===c.style&&"coil"===c.ss||"strand"===c.style&&"coil"===c.ss||"phosphorus trace"===c.style||"C alpha trace"===c.style||"B factor tube"===c.style||"cylinder & plate"===c.style&&"helix"!==c.ss){var v=!1;if(!v&&this.residues.hasOwnProperty(u)){var E=Object.keys(this.residues[u])[0],f=this.hash2Atoms(this.residues[u])[E];if(c.style===f.style&&!f.ssbegin||f.ssbegin){var g=this.residues[u];if(t=this.unionHash(t,g),v=!0,f.ssbegin)for(var a in g)this.atoms[a].notshow=!0}}if(!v&&this.residues.hasOwnProperty(p)){var E=Object.keys(this.residues[p])[0],f=this.hash2Atoms(this.residues[p])[E];
c.style===f.style&&(t=this.unionHash(t,this.residues[p]),v=!0)}}else if("ribbon"===c.style&&"coil"!==c.ss&&c.ssend||"strand"===c.style&&"coil"!==c.ss&&c.ssend){var v=!1;if(!v&&this.residues.hasOwnProperty(u)){var E=Object.keys(this.residues[u])[0],f=this.hash2Atoms(this.residues[u])[E];t=this.unionHash(t,this.residues[u]),v=!0}}}}this.setStyle2Atoms(t);for(var w in this.style2atoms)atomHash=this.style2atoms[w],"ribbon"===w?this.createStrand(this.hash2Atoms(atomHash),2,void 0,!0,void 0,void 0,!1,this.thickness,o):"strand"===w?this.createStrand(this.hash2Atoms(atomHash),null,null,null,null,null,!1,void 0,o):"cylinder & plate"===w?this.createCylinderHelix(this.hash2Atoms(atomHash),1.6,o):"nucleotide cartoon"===w?(this.drawCartoonNucleicAcid(this.hash2Atoms(atomHash),null,this.thickness,o),2!==o&&this.drawNucleicAcidStick(this.hash2Atoms(atomHash),o)):"phosphorus trace"===w?this.createCylinderCurve(this.hash2Atoms(atomHash),"P",.2,!1,o):"phosphorus lines"===w?this.createCylinderCurve(this.hash2Atoms(atomHash),"P",.2,!0,o):"C alpha trace"===w?this.createCylinderCurve(this.hash2Atoms(atomHash),"CA",.2,!1,o):"B factor tube"===w?this.createTube(this.hash2Atoms(atomHash),"CA",null,o):"lines"===w?1===o?this.createStickRepresentation(this.hash2Atoms(atomHash),.1,.1,void 0,o):this.createLineRepresentation(this.hash2Atoms(atomHash),o):"stick"===w?this.createStickRepresentation(this.hash2Atoms(atomHash),this.cylinderRadius,this.cylinderRadius,void 0,o):"ball & stick"===w?this.createStickRepresentation(this.hash2Atoms(atomHash),this.cylinderRadius,.5*this.cylinderRadius,.3,o):"sphere"===w?this.createSphereRepresentation(this.hash2Atoms(atomHash),this.sphereRadius,void 0,void 0,o):"dot"===w&&this.createSphereRepresentation(this.hash2Atoms(atomHash),this.sphereRadius,!1,.3,o)},setStyle2Atoms:function(e){this.style2atoms={};for(var t in e)void 0===this.style2atoms[this.atoms[t].style]&&(this.style2atoms[this.atoms[t].style]={}),this.style2atoms[this.atoms[t].style][t]=1},setAtomStyleByOptions:function(e){if(void 0!==e.sidechains)for(var t in this.proteins)this.atoms[t].style=e.sidechains.toLowerCase();if(void 0!==e.secondary)for(var t in this.proteins)this.atoms[t].style=e.secondary.toLowerCase();if(void 0!==e.ligands)for(var t in this.ligands)this.atoms[t].style=e.ligands.toLowerCase();if(void 0!==e.ions)for(var t in this.ions)this.atoms[t].style=e.ions.toLowerCase();if(void 0!==e.water)for(var t in this.water)this.atoms[t].style=e.water.toLowerCase();if(void 0!==e.nucleotides)for(var t in this.nucleotides)this.atoms[t].style=e.nucleotides.toLowerCase()},rebuildScene:function(e){if(jQuery.extend(this.options,e),void 0!==this.scene)for(var t=this.scene.children.length-1;t>=0;t--){var o=this.scene.children[t];this.scene.remove(o)}else this.scene=new THREE.Scene;this.directionalLight=new THREE.DirectionalLight(16777215,1.2),this.camera_z>0?this.directionalLight.position.set(0,0,1):this.directionalLight.position.set(0,0,-1);var i=new THREE.AmbientLight(2105376);if(this.scene.add(this.directionalLight),this.scene.add(i),void 0!==this.mdl){for(var t=this.mdl.children.length-1;t>=0;t--){var o=this.mdl.children[t];this.mdl.remove(o)}this.options.rotationcenter="nochange"}else this.mdl=new THREE.Object3D;this.scene.add(this.mdl),this.objects=[],this.raycaster=new THREE.Raycaster,this.projector=new THREE.Projector,this.mouse=new THREE.Vector2;var r=this.backgroundColors[this.options.background.toLowerCase()];this.renderer.setClearColor(r),this.perspectiveCamera=new THREE.PerspectiveCamera(20,this.container.whratio,.1,1e4),this.perspectiveCamera.position.set(0,0,this.camera_z),this.perspectiveCamera.lookAt(new THREE.Vector3(0,0,0)),this.orthographicCamera=new THREE.OrthographicCamera,this.orthographicCamera.position.set(0,0,this.camera_z),this.orthographicCamera.lookAt(new THREE.Vector3(0,0,0)),this.cameras={perspective:this.perspectiveCamera,orthographic:this.orthographicCamera},this.setCamera(),this.applyOptions(this.options)},setCamera:function(){this.camera=this.cameras[this.options.camera.toLowerCase()],this.camera===this.perspectiveCamera?(this.camera_z>0?this.camera.position.z=2*this.maxD:this.camera.position.z=2*-this.maxD,this.controls=new THREE.TrackballControls(this.camera,document.getElementById(this.id),this)):this.camera===this.orthographicCamera&&(this.camera.right=this.maxD/2*2.5,this.camera.left=-this.camera.right,this.camera.top=this.camera.right/this.container.whratio,this.camera.bottom=-this.camera.right/this.container.whratio,this.camera_z>0?(this.camera.near=1e4,this.camera.far=-1e4):(this.camera.near=-1e4,this.camera.far=1e4),this.controls=new THREE.OrthographicTrackballControls(this.camera,document.getElementById(this.id),this)),this.camera.updateProjectionMatrix()},applyTransformation:function(e,t,o){var i={};i.update=!1,i._zoomFactor=e,i.mouseChange=new THREE.Vector2,i.mouseChange.copy(t),i.quaternion=new THREE.Quaternion,i.quaternion.copy(o),this.controls.update(i)},render:function(){this.directionalLight.position.copy(this.camera.position),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.render(this.scene,this.camera)},setRotationCenter:function(e){this.mdl.position.sub(e)},draw:function(e,t){this.rebuildScene(e),(void 0===t||t)&&this.applyPrevColor(),this.bSSOnly&&this.drawHelixBrick(this.molid2ss,this.molid2color),this.bAssembly&&this.drawSymmetryMates2(),void 0!==this.highlightAtoms&&Object.keys(this.highlightAtoms).length>0&&Object.keys(this.highlightAtoms).length<Object.keys(this.displayAtoms).length&&(this.removeHighlightObjects(),this.addHighlightObjects(void 0,void 0)),this.bRender===!0&&(this.applyTransformation(this._zoomFactor,this.mouseChange,this.quaternion),this.render())},zoomIn:function(e){var t={};t._zoomFactor=1-e,t.update=!0,this.controls.update(t),this.render()},zoomOut:function(e){var t={};t._zoomFactor=1+e,t.update=!0,this.controls.update(t),this.render()},rotateLeft:function(e){var t=new THREE.Vector3(0,1,0),o=-e/180*Math.PI;t.applyQuaternion(this.camera.quaternion).normalize();var i=new THREE.Quaternion;i.setFromAxisAngle(t,-o);var r={};r.quaternion=i,r.update=!0,this.controls.update(r),this.render()},rotateRight:function(e){var t=new THREE.Vector3(0,1,0),o=e/180*Math.PI;t.applyQuaternion(this.camera.quaternion).normalize();var i=new THREE.Quaternion;i.setFromAxisAngle(t,-o);var r={};r.quaternion=i,r.update=!0,this.controls.update(r),this.render()},rotateUp:function(e){var t=new THREE.Vector3(1,0,0),o=-e/180*Math.PI;t.applyQuaternion(this.camera.quaternion).normalize();var i=new THREE.Quaternion;i.setFromAxisAngle(t,-o);var r={};r.quaternion=i,r.update=!0,this.controls.update(r),this.render()},rotateDown:function(e){var t=new THREE.Vector3(1,0,0),o=e/180*Math.PI;t.applyQuaternion(this.camera.quaternion).normalize();var i=new THREE.Quaternion;i.setFromAxisAngle(t,-o);var r={};r.quaternion=i,r.update=!0,this.controls.update(r),this.render()},translateLeft:function(e){var t=new THREE.Vector2(0,0);t.x-=e/100;var o={};o.mouseChange=t,o.update=!0,this.controls.update(o),this.render()},translateRight:function(e){var t=new THREE.Vector2(0,0);t.x+=e/100;var o={};o.mouseChange=t,o.update=!0,this.controls.update(o),this.render()},translateUp:function(e){var t=new THREE.Vector2(0,0);t.y-=e/100;var o={};o.mouseChange=t,o.update=!0,this.controls.update(o),this.render()},translateDown:function(e){var t=new THREE.Vector2(0,0);t.y+=e/100;var o={};o.mouseChange=t,o.update=!0,this.controls.update(o),this.render()},showPicking:function(e){if(this.removeHighlightObjects(),this.highlightAtoms={},1===this.picking)this.highlightAtoms[e.serial]=1;else if(2===this.picking){var t=e.structure+"_"+e.chain+"_"+e.resi;this.highlightAtoms=this.residues[t]}this.addHighlightObjects();var o="."+e.chain+":"+e.resi,i=o+"@"+e.name,r=[],n={};n.position=e.coord,1===this.picking?n.text=i:2===this.picking&&(n.text=o),r.push(n),this.createLabelRepresentation(r)},removeHighlightObjects:function(){for(var e in this.prevHighlightObjects)this.mdl.remove(this.prevHighlightObjects[e]);this.prevHighlightObjects=[],this.render()},addHighlightObjects:function(e){void 0===e&&(e=this.highlightColor),this.applyDisplayOptions(this.options,this.intersectHash(this.highlightAtoms,this.displayAtoms),this.bHighlight),this.render()},zoominSelection:function(){if(Object.keys(this.highlightAtoms).length>1){var e=this.centerAtoms(this.hash2Atoms(this.highlightAtoms));this.maxD=e.maxD,this.maxD<25&&(this.maxD=25),this.mdl.position.add(this.center).sub(e.center),this.center=e.center,this.setCamera()}this.render()}};var show3DStructure=function(e){function t(){if(void 0!==e.pdbid){var t=e.pdbid.toLowerCase();o(t)}else if(void 0!==e.mmdbid)c(e.mmdbid);else if(void 0!==e.gi){var i="https://eutils.ncbi.nlm.nih.gov/entrez/eutils/elink.fcgi?dbfrom=protein&db=structure&linkname=protein_structure&id="+e.gi;$.ajax({url:i,dataType:"text",cache:!0,success:function(t){if(-1===t.indexOf("<Link>"))alert("There are no MMDB IDs available for the gi "+e.gi);else{var o=t.substr(t.indexOf("<Link>")),i=o.indexOf("<Id>"),r=o.indexOf("</Id>"),n=o.substr(i+4,r-i-4);c(n)}}})}else void 0!==e.cid?s(e.cid):void 0!==e.mmcif?r(e.mmcif):void 0!==e.align?n(e.align):alert("Please input a gi, MMDB ID, PDB ID, CID, or mmCIF...")}function o(t){var o="https:"!==document.location.protocol?"http://www.rcsb.org/pdb/files/"+t+".pdb":"https://www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi?pdbid="+t;g.bCid=void 0;$.ajax({url:o,dataType:"text",cache:!0,beforeSend:function(){$("#"+m+"wait").show(),$("#"+m+"canvas").hide()},complete:function(){$("#"+m+"wait").hide(),$("#"+m+"canvas").show()},success:function(o){g.loadPDB(o),g.inputid.idtype="pdbid",g.inputid.id=t,g.setAtomStyleByOptions(w),g.setColorByOptions(w,g.atoms),g.draw(w),void 0!==e.rotate&&e.rotate&&i("right")}})}function i(e){if(g.bStopRotate)return!1;if("left"===e)g.rotateLeft(5);else if("right"===e)g.rotateRight(5);else if("up"===e)g.rotateUp(5);else{if("down"!==e)return!1;g.rotateDown(5)}setTimeout(function(){i(e)},1e3)}function r(t){var o="https://www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi?mmcif="+t;g.bCid=void 0,$.ajax({url:o,dataType:"jsonp",cache:!0,beforeSend:function(){$("#"+m+"wait").show(),$("#"+m+"canvas").hide(),$("#"+m+"log").hide()},complete:function(){$("#"+m+"wait").hide(),$("#"+m+"canvas").show(),$("#"+m+"log").show()},success:function(o){return void 0===o.atoms?(alert("invalid atoms data."),!1):(h(o,o.mmcif,"mmcif"),g.inputid.idtype="mmcif",g.inputid.id=t,g.setAtomStyleByOptions(w),g.setColorByOptions(w,g.atoms),g.draw(w),void 0!==e.rotate&&e.rotate&&i("right"),void 0)}})}function n(t){var o="https://www.ncbi.nlm.nih.gov/Structure/vastpp/vastpp.cgi?cmd=c&w3d&ids="+t,r="https://www.ncbi.nlm.nih.gov/Structure/vastpp/vastpp.cgi?cmd=c1&d&ids="+t;void 0!==e.inpara&&(o+=e.inpara,r+=e.inpara),g.bCid=void 0,g.pdbid_chain2title={};var n,s=$.ajax({url:r,dataType:"jsonp",cache:!0,beforeSend:function(){$("#"+m+"wait").show(),$("#"+m+"canvas").hide()},complete:function(){$("#"+m+"wait").hide(),$("#"+m+"canvas").show()}}),a=s.then(function(e){n=e.seqalign;var t=0;for(var i in e){if(2>t){var r=e[i].pdbid,s=e[i].molecule;for(var a in s){var c=s[a].chain;g.pdbid_chain2title[r+"_"+c]=s[a].name}}++t}return $.ajax({url:o,dataType:"jsonp",cache:!0,beforeSend:function(){$("#"+m+"wait").show(),$("#"+m+"canvas").hide()},complete:function(){$("#"+m+"wait").hide(),$("#"+m+"canvas").show()}})});a.done(function(o){return void 0===o.atoms?(alert("invalid atoms data."),!1):(h(o,void 0,"align",n),g.inputid.idtype="alignment",g.inputid.id=t,g.setAtomStyleByOptions(w),g.setColorByOptions(w,g.atoms,!0),g.draw(w),void 0!==e.rotate&&e.rotate&&i("right"),void 0)})}function s(t){var o="https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+t+"/SDF?record_type=3d";g.bCid=!0,$.ajax({url:o,dataType:"text",cache:!0,beforeSend:function(){$("#"+m+"wait").show(),$("#"+m+"canvas").hide(),$("#"+m+"log").hide()},complete:function(){$("#"+m+"wait").hide(),$("#"+m+"canvas").show(),$("#"+m+"log").show()},success:function(o){var r=a(o);r?(g.inputid.idtype="cid",g.inputid.id=t,g.setAtomStyleByOptions(w),g.setColorByOptions(w,g.atoms),g.draw(w),void 0!==e.rotate&&e.rotate&&i("right")):alert("The SDF of CID "+t+" has the wrong format...")}}).fail(function(){alert("This CID may not have 3D structure...")})}function a(e){var t=e.split("\n");if(t.length<4)return!1;g.init();var o="1",i="1",r="1",n="LIG",s=o,a=o+"_"+i,c=a+"_"+r,h=parseInt(t[3].substr(0,3));if(isNaN(h)||0>=h)return!1;var l=parseInt(t[3].substr(3,3)),d=4;if(t.length<d+h+l)return!1;var p,u,m=0,v=h,E={};for(p=m;v>p;p++){u=t[d],d++;var f=p,w=parseFloat(u.substr(0,10)),b=parseFloat(u.substr(10,10)),y=parseFloat(u.substr(20,10)),T=new THREE.Vector3(w,b,y),R=u.substr(31,3).replace(/ /g,""),H={het:!0,serial:f,name:R,resn:n,structure:o,chain:i,resi:r,coord:T,b:0,elem:R,bonds:[],ss:"coil",ssbegin:!1,ssend:!1,bondOrder:[]};g.atoms[f]=H,E[f]=1}for(g.displayAtoms=E,g.highlightAtoms=E,g.structures[s]=E,g.chains[a]=E,g.residues[c]=E,g.residueId2Name[c]=n,void 0===g.chainsSeq[a]&&(g.chainsSeq[a]=[]),void 0===g.chainsAnno[a]&&(g.chainsAnno[a]=[]),void 0===g.chainsAnno[a][0]&&(g.chainsAnno[a][0]=[]),g.chainsSeq[a].push(n),g.chainsAnno[a][0].push(r),p=0;l>p;p++){u=t[d],d++;var C=parseInt(u.substr(0,3))-1+m,x=parseInt(u.substr(3,3))-1+m,S=parseInt(u.substr(6,3));g.atoms[C].bonds.push(x),g.atoms[C].bondOrder.push(S),g.atoms[x].bonds.push(C),g.atoms[x].bondOrder.push(S)}var A=new THREE.Vector3(9999,9999,9999),_=new THREE.Vector3(-9999,-9999,-9999),M=new THREE.Vector3,O=0;for(var p in g.atoms){var k=g.atoms[p],T=k.coord;M.add(T),A.min(T),_.max(T),++O,k.het&&(-1!==$.inArray(k.elem,g.ionsArray)?g.ions[k.serial]=1:g.ligands[k.serial]=1)}return g.pmin=A,g.pmax=_,g.cnt=O,g.maxD=g.pmax.distanceTo(g.pmin),g.center=M.multiplyScalar(1/g.cnt),g.maxD<25&&(g.maxD=25),!0}function c(t){var o="https://www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?program=w3d&uid="+t;g.bCid=void 0,void 0!==e.inpara&&(o+=e.inpara),$.ajax({url:o,dataType:"jsonp",cache:!0,beforeSend:function(){$("#"+m+"wait").show(),$("#"+m+"canvas").hide()},complete:function(){$("#"+m+"wait").hide(),$("#"+m+"canvas").show()},success:function(t){if(void 0!==e.inpara&&-1!=e.inpara.indexOf("mols=")||t.atomcount<=t.threshold&&void 0!==t.atoms){var o=void 0!==t.pdbId?t.pdbId:t.mmdbId;h(t,o,"mmdbid"),g.inputid.idtype="mmdbid",g.inputid.id=o,g.setAtomStyleByOptions(w),g.setColorByOptions(w,g.atoms,!0),g.draw(w),void 0!==e.rotate&&e.rotate&&i("right")}if(void 0!==e.inpara&&-1==e.inpara.indexOf("mols=")&&t.atomcount>t.threshold&&void 0!==t.molid2rescount){var r=40;g.bSSOnly=!0;var o=void 0!==t.pdbId?t.pdbId:t.mmdbId;h(t,o,"mmdbid"),g.inputid.idtype="mmdbid",g.inputid.id=o,w.nucleotides="phosphorus lines",g.setAtomStyleByOptions(w),g.setColorByOptions(w,g.atoms,!0);var n=t.molid2rescount,s={},a={},c={},l="<table width='100%'><tr><td></td><th>#</th><th align='center'>Chain</th><th align='center'>Residue Count</th></tr>",d=1;for(var p in n){var u="#"+("000000"+n[p].color.toString(16)).slice(-6);l+="<tr style='color:"+u+"'><td><input type='checkbox' name='"+m+"filter_ckbx' value='"+p+"'/></td><td align='center'>"+d+"</td><td align='center'>"+n[p].chain+"</td><td align='center'>"+n[p].resCount+"</td></tr>",s[p]=u;var v=o+"_"+n[p].chain;a[v]=p,c[p]=v,++d}Object.keys(g.ligands).length>0&&(l+="<tr><td><input type='checkbox' name='"+m+"filter_ckbx' value='ligands'/></td><td align='center'>"+d+"</td><td align='center'>Ligands</td><td align='center'>"+Object.keys(g.ligands).length+" atoms</td></tr>"),l+="</table>";var E={};for(var p in g.chains){var f={},b=g.centerAtoms(g.hash2Atoms(g.chains[p]));f.position=b;var v=p.substr(p.indexOf("_")+1);f.text=v,f.size=r,f.color=s[a[p]],f.background="#FFFFFF",E[a[p]]=f}molid2ss={};for(var p in t.helix)for(var y=0,T=t.helix[p].length;T>y;++y){var R=t.helix[p][y],H={};H.type="helix",H.startResi=R.from,H.endResi=R.to,H.coords=[],H.coords.push(R.end),H.coords.push(R.start),void 0===molid2ss[p]&&(molid2ss[p]=[]),molid2ss[p].push(H)}for(var p in t.brick)for(var y=0,T=t.brick[p].length;T>y;++y){var C=t.brick[p][y],H={};H.type="brick",H.startResi=C.from,H.endResi=C.to,H.coords=[];var x={},S={},A={};x.x=.25*(C["000"][0]+C["010"][0]+C["011"][0]+C["001"][0]),x.y=.25*(C["000"][1]+C["010"][1]+C["011"][1]+C["001"][1]),x.z=.25*(C["000"][2]+C["010"][2]+C["011"][2]+C["001"][2]),S.x=.25*(C[100][0]+C[110][0]+C[111][0]+C[101][0]),S.y=.25*(C[100][1]+C[110][1]+C[111][1]+C[101][1]),S.z=.25*(C[100][2]+C[110][2]+C[111][2]+C[101][2]),A.x=C["010"][0]-C["000"][0],A.y=C["010"][1]-C["000"][1],A.z=C["010"][2]-C["000"][2],H.coords.push(x),H.coords.push(S),H.coords.push(A),void 0===molid2ss[p]&&(molid2ss[p]=[]),molid2ss[p].push(H)}for(var p in molid2ss)molid2ss[p].sort(function(e,t){return parseFloat(e.startResi)-parseFloat(t.startResi)});if(0!==g.cnt)var _=g.pmin,M=g.pmax,O=g.center.multiplyScalar(g.cnt),k=g.cnt;else var _=new THREE.Vector3(9999,9999,9999),M=new THREE.Vector3(-9999,-9999,-9999),O=new THREE.Vector3,k=0;for(var p in molid2ss){for(var z=new THREE.Vector3(9999,9999,9999),L=new THREE.Vector3(-9999,-9999,-9999),V=new THREE.Vector3,j=0,y=0,T=molid2ss[p].length;T>y;++y){var P=molid2ss[p][y].coords[0];_.min(P),M.max(P),O.add(P),z.min(P),L.max(P),V.add(P),++k,++j,P=molid2ss[p][y].coords[1],_.min(P),M.max(P),O.add(P),z.min(P),L.max(P),V.add(P),++k,++j}var F=V.multiplyScalar(1/j),f={},b=new THREE.Vector3;b.x=F.x,b.y=F.y,b.z=F.z,f.position=b;var v=c[p];f.text=v.substr(v.indexOf("_")+1),f.size=r,f.color=s[p],f.background="#FFFFFF",E[p]=f}g.maxD=M.distanceTo(_),g.center=O.multiplyScalar(1/k);for(var p in molid2ss)for(var y=1,T=molid2ss[p].length;T>y;++y){var H={};H.type="coil",H.startResi=molid2ss[p][y-1].endResi,H.endResi=molid2ss[p][y].startResi,H.coords=[],H.coords.push(molid2ss[p][y-1].coords[1]),H.coords.push(molid2ss[p][y].coords[0]),molid2ss[p].push(H)}g.savedLabels=E,g.molid2ss=molid2ss,g.molid2color=s,g.draw(w),void 0!==e.rotate&&e.rotate&&i("right"),$("#"+m+"dl_filter_table").html(l);var D="Select chains to display",N=250,I=/Mac/i.test(navigator.userAgent)&&!/iPhone|iPad|iPod/i.test(navigator.userAgent)?"auto":200,b={my:"left top",at:"left+10 top+93",of:"#"+m+"canvas",collision:"none"};window.dialog=$("#"+m+"dl_filter").dialog({autoOpen:!0,title:D,height:I,width:N,modal:!1,position:b}),$(".ui-dialog .ui-button span").removeClass("ui-icon-closethick").addClass("ui-icon-close")}return void 0===t.atoms&&void 0===t.molid2rescount?(alert("invalid MMDB data."),!1):void 0}})}function h(e,t,o,i){g.init();var r=new THREE.Vector3(9999,9999,9999),n=new THREE.Vector3(-9999,-9999,-9999),s=new THREE.Vector3,a=e.atoms,c=0,h=0,l={},d={};if("align"===o)for(var p=0,u=e.aligned_structures.length;u>p;++p)for(var m=e.aligned_structures[p],v=m.range[0];v<=m.range[1];++v){var E=m.pdbid,f=m.mmdbid;l[v]=E.toString(),d[f]=E}var w={},b={};if("mmdbid"===o||"align"===o)if("mmdbid"===o){if(void 0!==e.molid2chain)for(var y in e.molid2chain)w[y]=e.molid2chain[y].chain}else if("align"===o&&void 0!==e.molid2chain)for(var T in e.molid2chain)for(var y in e.molid2chain[T])b[d[T]+"_"+y]=e.molid2chain[T][y].chain;var R={};for(var p in a){++c,R[p]=c;var H=a[p];H.serial=c;var C;if("mmdbid"===o||"mmcif"===o?C=t:"align"===o&&(C=l[c]),void 0!==H.chain||"mmdbid"!==o&&"align"!==o)H.chain=""===H.chain?"?":H.chain;else if("mmdbid"===o){var y=H.ids.m;H.chain=void 0===w[y]?"?":w[y]}else if("align"===o){var y=H.ids.m;H.chain=void 0===b[C+"_"+y]?"?":b[C+"_"+y]}H.resi=parseInt(H.resi),void 0!==H.color&&(H.color=new THREE.Color(H.color)),H.coord=new THREE.Vector3(H.coord.x,H.coord.y,H.coord.z),("mmdbid"===o||"align"===o)&&(H.structure=C),r.min(H.coord),n.max(H.coord),s.add(H.coord),"p"===H.mt||"n"===H.mt?("p"===H.mt?(g.proteins[c]=1,"CA"===H.name&&(g.calphas[c]=1)):"n"===H.mt&&(g.nucleotides[c]=1,"P"==H.name&&(g.nucleotidesP[c]=1)),g.het=!1):"s"===H.mt?(g.water[c]=1,g.het=!0):"l"===H.mt&&(g.ligands[c]=1,0===H.bonds.length&&(g.ions[c]=1),g.het=!0),"HOH"==H.resn&&(g.water[c]=1),g.atoms[c]=H,g.displayAtoms[c]=1,g.highlightAtoms[c]=1,void 0===g.structures[C]&&(g.structures[C]={}),g.structures[C][c]=1;var x=H.structure+"_"+H.chain;void 0===g.chains[x]&&(g.chains[x]={}),g.chains[x][c]=1;var S=H.structure+"_"+H.chain+"_"+H.resi;void 0===g.residues[S]&&(g.residues[S]={}),g.residues[S][c]=1;var A=g.residueName2Abbr(H.resn.substr(0,3));g.residueId2Name[S]=A,H.resi!=h&&(void 0===g.chainsSeq[x]&&(g.chainsSeq[x]=[]),void 0===g.chainsAnno[x]&&(g.chainsAnno[x]=[]),void 0===g.chainsAnno[x][0]&&(g.chainsAnno[x][0]=[]),void 0===g.chainsAnnoTitle[x]&&(g.chainsAnnoTitle[x]=[]),void 0===g.chainsAnnoTitle[x][0]&&(g.chainsAnnoTitle[x][0]=[]),g.chainsSeq[x].push(A),g.chainsAnno[x][0].push(H.resi),g.chainsAnnoTitle[x][0].push(""),("mmdbid"===o||"align"===o)&&(g.chainsColor[x]=H.color)),h=H.resi}if("mmcif"!==o)for(var p in g.atoms)for(var _=void 0===g.atoms[p].bonds?0:g.atoms[p].bonds.length,v=0;_>v;++v)g.atoms[p].bonds[v]=R[g.atoms[p].bonds[v]];if(g.cnt=c,g.pmin=r,g.pmax=n,g.maxD=n.distanceTo(r),g.center=s.multiplyScalar(1/g.cnt),g.maxD<25&&(g.maxD=25),"align"===o&&void 0!==i)for(var p=0,u=i.length;u>p;++p){for(var M=i[p][0],O=e.aligned_structures[0].pdbid,k=M.mid,z=b[O+"_"+k],L=O+"_"+z,V={},j=M.mseq.length,P=-1,v=0,F=M.mseq.length;F>v;++v){var D=M.mseq[v][1],N="~"===M.mseq[v][2]?"-":M.mseq[v][2],I=M.mseq[v][3];1==I&&(j>v&&(j=v),v>P&&(P=v)),V[v]={resi:D,resn:N,aligned:I}}M=i[p][1];var B=e.aligned_structures[1].pdbid,G=M.sid,q=b[B+"_"+G],W=B+"_"+q;void 0===g.alignChainsAnnoTitle[L]&&(g.alignChainsAnnoTitle[L]=[]),void 0===g.alignChainsAnnoTitle[L][0]&&(g.alignChainsAnnoTitle[L][0]=[]),void 0===g.alignChainsAnnoTitle[L][1]&&(g.alignChainsAnnoTitle[L][1]=[]),void 0===g.alignChainsAnnoTitle[L][2]&&(g.alignChainsAnnoTitle[L][2]=[]),void 0===g.alignChainsAnnoTitle[L][3]&&(g.alignChainsAnnoTitle[L][3]=[]),void 0===g.alignChainsAnnoTitle[L][4]&&(g.alignChainsAnnoTitle[L][4]=[]),void 0===g.alignChainsAnnoTitle[L][5]&&(g.alignChainsAnnoTitle[L][5]=[]),g.chainsAnnoTitle[L][0].push(""),g.alignChainsAnnoTitle[L][0].push(""),g.alignChainsAnnoTitle[L][1].push(""),g.alignChainsAnnoTitle[L][2].push(""),g.alignChainsAnnoTitle[L][3].push(W),g.alignChainsAnnoTitle[L][4].push(L),g.alignChainsAnnoTitle[L][5].push("");for(var Y=1,v=j;P>=v;++v){var U,D=M.sseq[v][1],N="~"===M.sseq[v][2]?"-":M.sseq[v][2],I=V[v].aligned+M.sseq[v][3];U=2===I?V[v].resn===N?"#F00":"#00F":"#CCC",void 0===g.alignChainsSeq[L]&&(g.alignChainsSeq[L]=[]);var X={};X.mmdbid=O,X.chain=z,X.resi=V[v].resi,X.resn=V[v].resn,X.aligned=I,X.color=U,g.alignChainsSeq[L].push(X),isNaN(V[v].resi)||(void 0===g.alignChains[L]&&(g.alignChains[L]={}),$.extend(g.alignChains[L],g.residues[L+"_"+V[v].resi])),void 0===g.alignChainsSeq[W]&&(g.alignChainsSeq[W]=[]),X={},X.mmdbid=B,X.chain=q,X.resi=D,X.resn=N,X.aligned=I,X.color=U,g.alignChainsSeq[W].push(X),isNaN(D)||(void 0===g.alignChains[W]&&(g.alignChains[W]={}),$.extend(g.alignChains[W],g.residues[W+"_"+D])),void 0===g.alignChainsAnno[L]&&(g.alignChainsAnno[L]=[]),void 0===g.alignChainsAnno[L][0]&&(g.alignChainsAnno[L][0]=[]),void 0===g.alignChainsAnno[L][1]&&(g.alignChainsAnno[L][1]=[]),v===j&&(void 0===g.alignChainsAnno[L][2]&&(g.alignChainsAnno[L][2]=[]),void 0===g.alignChainsAnno[L][3]&&(g.alignChainsAnno[L][3]=[]),void 0===g.alignChainsAnno[L][4]&&(g.alignChainsAnno[L][4]=[]),void 0===g.alignChainsAnno[L][5]&&(g.alignChainsAnno[L][5]=[]),g.alignChainsAnno[L][2].push(""),g.alignChainsAnno[L][3].push(g.pdbid_chain2title[W]),g.alignChainsAnno[L][4].push(g.pdbid_chain2title[L]),g.alignChainsAnno[L][5].push(""));var Q=".";Y%5===0&&(Q="*"),Y%10===0&&(Q="|"),g.alignChainsAnno[L][0].push(Q);var Z="";Y%10===0&&(Z=Y.toString()),g.alignChainsAnno[L][1].push(Z),++Y}}}function l(){for(var e in g.atoms)g.highlightAtoms[e]=1}function d(e,t){var o={};o[e]=t,l(),g.setColorByOptions(o,g.atoms),g.draw(o)}function p(e,t){var o={};switch(l(),e){case"secondary":o=g.intersectHash(g.highlightAtoms,g.proteins);break;case"sidechains":o=g.intersectHash(g.highlightAtoms,g.proteins);break;case"nucleotides":o=g.intersectHash(g.highlightAtoms,g.nucleotides);break;case"ligands":o=g.intersectHash(g.highlightAtoms,g.ligands);break;case"ions":o=g.intersectHash(g.highlightAtoms,g.ions);break;case"water":o=g.intersectHash(g.highlightAtoms,g.water)}for(var i in o)g.atoms[i].style=t;g.draw(w)}var u=e.divid,m=u+"_";iCn3D.prototype.showPicking=function(t){if(this.removeHighlightObjects(),this.highlightAtoms={},1===this.picking)this.highlightAtoms[t.serial]=1;else if(2===this.picking){var o=t.structure+"_"+t.chain+"_"+t.resi;this.highlightAtoms=this.residues[o]}this.addHighlightObjects();var i,r="."+t.chain+":"+t.resi;i=void 0!==e.cid?t.name:r+"@"+t.name;var n=[],s={};s.position=t.coord,1===this.picking?s.text=i:2===this.picking&&(s.text=r),n.push(s),this.createLabelRepresentation(n)};var v="";v+="<div id='"+m+"viewer' style='position:relative; width:100%; height:100%;'>",v+="<!--div style='height:18px'></div-->",v+="<div id='"+m+"wait' style='width:100%; height: 100%; background-color: rgba(0,0,0, 0.8);'><div style='padding-top:25%; text-align: center; font-size: 2em; color: #FFFF00;'>Loading the structure...</div></div>",v+="<canvas id='"+m+"canvas' style='width:100%; height:100%;'>Your browser does not support WebGL.</canvas>",v+="<div class='tabBox' id='"+m+"toolbox'>",v+="<span class='bottomTab'>Tools</span>",v+="<div class='insideTab' style='overflow: auto;'>",v+="<form action='' id='"+m+"paraform' method='POST'>",void 0===e.cid&&(v+="<div class='option'>",v+="<b>&nbsp;&nbsp;Secondary Structure</b>",v+="<select id='"+m+"secondary'>",v+="<option value='ribbon' selected>ribbon</option>",v+="<option value='strand'>strand</option>",v+="<option value='cylinder & plate'>cylinder and plate</option>",v+="<option value='C alpha trace'>C alpha trace</option>",v+="<option value='B factor tube'>B factor tube</option>",v+="<option value='lines'>lines</option>",v+="<option value='stick'>stick</option>",v+="<option value='ball & stick'>ball and stick</option>",v+="<option value='sphere'>sphere</option>",v+="<option value='nothing'>hide</option>",v+="</select>",v+="</div>",v+="<div class='option'>",v+="<b>&nbsp;&nbsp;Nucleotides</b>",v+="<select id='"+m+"nucleotides'>",v+="<option value='nucleotide cartoon'>cartoon</option>",v+="<option value='phosphorus trace' selected>phosphorus trace</option>",v+="<option value='lines'>lines</option>",v+="<option value='stick'>stick</option>",v+="<option value='ball & stick'>ball and stick</option>",v+="<option value='sphere'>sphere</option>",v+="<option value='nothing'>hide</option>",v+="</select>",v+="</div>"),v+="<div class='option'>",v+="<b>&nbsp;&nbsp;Ligands</b>",v+="<select id='"+m+"ligands'>",v+="<option value='lines'>lines</option>",v+="<option value='stick' selected>stick</option>",v+="<option value='ball & stick'>ball and stick</option>",v+="<option value='sphere'>sphere</option>",v+="<option value='nothing'>hide</option>",v+="</select>",v+="</div>",v+="<div class='option'>",v+="<b>&nbsp;&nbsp;Color</b>",v+="<select id='"+m+"color'>",void 0===e.cid&&(v+="<option value='spectrum' selected>spectrum</option>",v+="<option value='chain'>chain</option>",v+="<option value='secondary structure'>secondary structure</option>",v+="<option value='B factor'>B factor</option>",v+="<option value='residue'>residue</option>",v+="<option value='polarity'>polarity</option>"),v+="<option value='atom'>atom</option>",v+="<option value='red'>red</option>",v+="<option value='green'>green</option>",v+="<option value='blue'>blue</option>",v+="<option value='magenta'>magenta</option>",v+="<option value='yellow'>yellow</option>",v+="<option value='cyan'>cyan</option>",v+="</select>",v+="</div>",v+="<div class='option'>",v+="&nbsp;&nbsp;<button class='enablepick'>Picking</button> <button class='disablepick'>No Picking</button>",v+="</div>",v+="<div class='option'>",v+="&nbsp;&nbsp;<button id='"+m+"reset'>Reset</button>",v+="</div>",v+="</form>",v+="</div>",v+="</div>",v+="</div>",v+="<!-- dialog will not be part of the form -->",v+="<div id='"+m+"allselections' class='hidden'>",v+="<div id='"+m+"dl_filter' style='overflow:auto; position:relative'>",v+="  <div style='text-align:center; margin-bottom:10px;'><button id='"+m+"filter'><span style='white-space:nowrap'><b>Show Structure</b></span></button>",v+="<button id='"+m+"label_3d_diagram' style='margin-left:10px;'><span style='white-space:nowrap'><b>Show Labels</b></span></button></div>",v+="  <div id='"+m+"dl_filter_table' class='box'>",v+="  </div>",v+="</div>",v+="</div>",$("#"+u).html(v);var E=window.innerWidth,f=window.innerHeight;E=-1!==e.width.toString().indexOf("%")?E*e.width.substr(0,e.width.toString().indexOf("%"))/100-20:e.width,f=-1!==e.height.toString().indexOf("%")?f*e.height.substr(0,e.height.toString().indexOf("%"))/100-20:e.height,$("#"+m+"viewer").width(E).height(f),$("#"+m+"canvas").width(E).height(f),parseInt(E)<=200&&$("#"+m+"toolbox").hide(),$(".bottomTab").click(function(e){var t=$(".insideTab").height();0===t?$(".insideTab").height(200):$(".insideTab").height(0)});var g=new iCn3D(m+"canvas");void 0!==e.bCalphaOnly&&(g.bCalphaOnly=e.bCalphaOnly);var w={};w.camera="perspective",w.background="black",w.color="spectrum",w.sidechains="nothing",w.secondary="ribbon",w.surface="nothing",w.opacity="0.8",w.wireframe="no",w.ligands="stick",w.water="nothing",w.ions="sphere",w.hbonds="no",w.labels="no",w.lines="no",w.rotationcenter="molecule center",w.axis="no",w.picking="residue",w.nucleotides="phosphorus trace",w.surfaceregion="nothing",void 0!==e.cid&&(w.picking="atom"),g.cloneHash(w,g.options),t(),$(".enablepick").click(function(t){t.preventDefault(),void 0!==e.cid?(g.picking=1,g.options.picking="atom"):(g.picking=2,g.options.picking="residue")}),$(".disablepick").click(function(e){e.preventDefault(),g.picking=0,g.options.picking="no",g.draw(void 0,void 0,!1),g.removeHighlightObjects()}),$("#"+m+"reset").click(function(e){e.preventDefault(),t()}),$("#"+m+"filter_ckbx_all").click(function(e){var t=document.getElementsByName(m+"filter_ckbx");if(1==$(this)[0].checked)for(var o=0,i=t.length;i>o;++o)t[o].checked=!0;else for(var o=0,i=t.length;i>o;++o)t[o].checked=!1}),$("#"+m+"filter").click(function(e){e.preventDefault();for(var t=document.getElementsByName(m+"filter_ckbx"),o="",i="&het=0",r=0,n=t.length;n>r;++r)t[r].checked&&("ligands"==t[r].value?i="&het=2":o+=t[r].value+",");""==o&&(o=t[0].value);var s=document.URL+"&mols="+o+"&complexity=2"+i;window.open(s,"_self")}),$("#"+m+"label_3d_diagram").click(function(e){for(var t=document.getElementsByName(m+"filter_ckbx"),o=[],i=0,r=t.length;r>i;++i)t[i].checked&&"ligands"!=t[i].value&&o.push(g.savedLabels[t[i].value]);g.labels=o,g.createLabelRepresentation(g.labels),g.render()}),void 0!==e.resize&&e.resize&&!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$(window).resize(function(){void 0!==e.resize&&e.resize&&($("#"+m+"canvas").width($(window).width()-20).height($(window).height()-20),$("#"+m+"viewer").width($(window).width()-20).height($(window).height()-20),g.setWidthHeight($(window).width()-20,$(window).height()-20),g.draw(w))}),["color","sidechains","secondary","ligands","water","ions","nucleotides"].forEach(function(e){$("#"+m+e).change(function(t){"color"===e?d(e,$("#"+m+e).val()):p(e,$("#"+m+e).val())})})};